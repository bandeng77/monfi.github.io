<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Monitoring System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #79BAEC;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #94a3b8;
            --border: #e2e8f0;
            --bg: #ffffff;
            --card-bg: #ffffff;
            --sidebar-bg: #f1f5f9;
            --hover: #f8fafc;
            --pink: #FFC0CB; /* Semua pink menjadi #FFC0CB */
            --pink-light: #FFC0CB; /* Warna pink menjadi #FFC0CB */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #334155;
            line-height: 1.6;
            width: 100%;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* ========== IMPROVED LOGIN STYLES ========== */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
        }

        .auth-card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }

        .auth-card h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--dark);
            font-weight: 700;
            font-size: 1.75rem;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .auth-logo-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-right: 0.75rem;
        }

        .auth-logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--dark);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .auth-input-group {
            position: relative;
        }

        .auth-input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 2.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            font-size: 1rem;
        }

        .auth-submit-btn {
            padding: 0.9rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background-color: var(--primary);
            color: white;
            font-size: 1rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .auth-submit-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
        }

        .auth-submit-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .auth-submit-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .auth-error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
            border-left: 4px solid var(--danger);
        }

        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== EXISTING STYLES ========== */
        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }

        .logo-icon {
            font-size: 1.8rem;
            color: var(--primary);
            margin-right: 0.75rem;
        }

        .sidebar.collapsed .logo-icon {
            margin-right: 0;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--dark);
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: var(--secondary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background-color: var(--hover);
            color: var(--primary);
        }

        .nav-item.active {
            background-color: var(--primary); /* Menu aktif menggunakan warna pink #FFC0CB */
            color: var(--dark);
        }

        /* Warna pink untuk menu tertentu */
        .nav-item[data-target="dashboard-section"]:hover,
        .nav-item[data-target="faktur-pajak-section"]:hover,
        .nav-item[data-target="keterangan-section"]:hover,
        #logout-btn:hover {
            background-color: var(--pink); /* Menggunakan warna pink #FFC0CB */
            color: var(--dark);
        }

        .nav-item[data-target="dashboard-section"].active,
        .nav-item[data-target="faktur-pajak-section"].active,
        .nav-item[data-target="keterangan-section"].active {
            background-color: var(--pink); /* Menu aktif menggunakan warna pink #FFC0CB */
            color: var(--dark);
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .sidebar.collapsed .nav-icon {
            margin-right: 0;
        }

        .nav-text {
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: absolute;
            top: 1.5rem;
            right: -12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: right 0.3s ease, transform 0.3s ease;
            z-index: 10;
        }

        .sidebar.collapsed .sidebar-toggle {
            right: -12px;
            transform: rotate(180deg);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background-color: var(--hover);
        }

        .btn-icon {
            margin-right: 0.5rem;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        .filter-input {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            width: 100%;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        th, td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            word-wrap: break-word;
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--dark);
        }

        td {
            color: var(--secondary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .status-button {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
        }

        .status-button:hover {
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-paid {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-diajukan-finance {
            background-color: #bfdbfe;
            color: #1e40af;
        }

        .status-diterima-anggi {
            background-color: #dbeafe;
            color: #1e3a8a;
        }

        .status-dibatalkan {
            background-color: #fecaca;
            color: #b91c1c;
        }

        .status-belum-diproses, .status-menunggu-pengajuan {
            background-color: #e2e8f0;
            color: #475569;
        }

        .action-cell {
            gap: 0.5rem;
            white-space: nowrap;
        }

        .action-btn {
            padding: 0.4rem 0.6rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--secondary);
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background-color: var(--hover);
            color: var(--primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem 0;
        }

        .page-info {
            font-size: 0.875rem;
            color: var(--secondary);
        }

        .page-controls {
            display: flex;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover {
            background-color: var(--hover);
        }

        .page-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close-btn {
            color: var(--secondary);
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: var(--dark);
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            width: 100%;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background-color: var(--light);
        }

        .detail-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .detail-item {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .detail-item strong {
            width: 180px;
            flex-shrink: 0;
            color: var(--dark);
        }

        .detail-item span {
            flex-grow: 1;
            color: var(--secondary);
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border);
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
        }

        .autocomplete-items div:hover {
            background-color: var(--hover);
        }

        .autocomplete-active {
            background-color: var(--primary) !important;
            color: #ffffff;
        }

        .autocomplete-new-vendor {
            background-color: #f0f9ff !important;
            color: var(--primary);
            font-weight: 600;
            border-left: 3px solid var(--primary);
        }

        /* Custom Alert/Notification Styles */
        .custom-alert {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            color: white;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-alert.show {
            opacity: 1;
        }

        .custom-alert.success {
            background-color: var(--success);
        }

        .custom-alert.error {
            background-color: var(--danger);
        }

        .custom-alert.info {
            background-color: var(--primary);
        }

        /* Dashboard Summary Grid */
        .dashboard-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .summary-item {
            background-color: var(--light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .summary-item:hover {
            transform: translateY(-3px);
        }

        .summary-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--secondary);
        }

        /* Specific colors for summary items */
        .summary-item:nth-child(1) .summary-value { color: var(--dark); }
        .summary-item:nth-child(2) .summary-value { color: var(--success); }
        .summary-item:nth-child(3) .summary-value { color: var(--warning); }
        .summary-item:nth-child(4) .summary-value { color: var(--primary); }
        .summary-item:nth-child(5) .summary-value { color: var(--danger); }

        /* Settings Layout */
        .settings-layout {
            display: flex;
            justify-content: center;
            padding-top: 1rem;
        }

        .settings-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--dark);
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            body {
                width: 100%;
            }
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 1rem;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                gap: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            .nav-item {
                margin-bottom: 0;
                white-space: nowrap;
            }

            .sidebar-toggle {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .pagination {
                flex-direction: column;
                gap: 1rem;
            }

            .detail-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .detail-item strong {
                width: auto;
                margin-bottom: 0.25rem;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            .page-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Currency indicator styles */
        .currency-indicator {
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--light);
            color: var(--secondary);
        }

        .currency-idr {
            background-color: #e0f2fe;
            color: #0369a1;
        }

        .currency-usd {
            background-color: #f0fdf4;
            color: #15803d;
        }

        /* DPP & PPN Styles */
        .dpp-ppn-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .dpp-amount {
            font-weight: 500;
            color: var(--dark);
        }

        .ppn-amount {
            font-size: 0.85rem;
            color: var(--secondary);
        }

        /* Status Summary Modal */
        .status-summary-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .status-summary-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 100%;
            overflow-y: auto;
            position: relative;
        }

        .status-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .status-summary-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .status-summary-close-btn {
            color: var(--secondary);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .status-summary-close-btn:hover {
            color: var(--dark);
        }

        .status-summary-table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin-top: 1rem;
        }

        /* Keterangan Proses Styles */
        .keterangan-proses-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .keterangan-proses-cell:hover {
            overflow: visible;
            white-space: normal;
            position: relative;
            z-index: 10;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-wZ0y0jG-MstU1MPIQQg8pyLnefx8ADQ",
            authDomain: "monitoring-finance.firebaseapp.com",
            projectId: "monitoring-finance",
            storageBucket: "monitoring-finance.firebasestorage.app",
            messagingSenderId: "312581732577",
            appId: "1:312581732577:web:0ee71d80770eea1ed39fa0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firestore Collections references
        const invoicesCol = db.collection('invoices');
        const fakturPajakCol = db.collection('fakturPajak');
        const pembayaranCol = db.collection('pembayaran');
        const keteranganCol = db.collection('keterangan');

        // --- Custom Alert Function ---
        function showAlert(message, type = 'info', duration = 3000) {
            let alertBox = document.getElementById('custom-alert-box');
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'custom-alert-box';
                alertBox.className = 'custom-alert';
                document.body.appendChild(alertBox);
            }

            alertBox.textContent = message;
            alertBox.className = `custom-alert ${type}`;
            alertBox.style.display = 'block';

            // Trigger reflow to ensure transition plays
            void alertBox.offsetWidth;
            alertBox.classList.add('show');

            setTimeout(() => {
                alertBox.classList.remove('show');
                alertBox.addEventListener('transitionend', function handler() {
                    alertBox.style.display = 'none';
                    alertBox.removeEventListener('transitionend', handler);
                });
            }, duration);
        }

        // Global variables for invoice data and autocomplete
        let allInvoiceNumbers = [];
        let allInvoiceData = [];
        let filteredInvoiceData = [];
        window.currentPage = 1;
        const itemsPerPage = 25;

        // Global variables to store unsubscribe functions for realtime listeners
        window.invoiceUnsubscribe = null;
        window.dashboardUnsubscribe = null;
        window.reportUnsubscribe = null;

        // Global variables for vendor data
        let allVendorNames = [];

        // --- VENDOR MANAGEMENT FUNCTIONS ---
        // Load vendor data from localStorage or default sample
        async function loadVendorData() {
            try {
                // Coba load dari localStorage dulu
                const savedVendors = localStorage.getItem('vendorList');
                
                if (savedVendors) {
                    allVendorNames = JSON.parse(savedVendors);
                } else {
                    // Jika tidak ada di localStorage, gunakan sample vendors
                    const sampleVendors = [
                       "ALARM SUPPLY PTE LTD",
                       "ALLTECH SOLUSINDO",
                       "ALVASTA TEKNOLOGI",
                       "ARSITA UTAMA INDONESIA",
                       "ARSITA UTAMA INDONESIA. PT",
                       "ARTA KENCANA PRIMA MANDIRI",
                       "ASIA CIPTA MANAGEMENT",
                       "AUSTRALINDO GRAHA NUSA",
                       "BUANA SUKSES ABADI",
                       "BUANA SUKSES BERSAMA. PT",
                       "BUMEN CITRA MANDIRI",
                       "CAHAYA BUANA INDOABADI",
                       "CAHAYA KALIMAS UTAMA",
                       "CAKRA MITRA SENTOSA",
                       "CECEP DENI SAPUTRA ",
                       "CITRA INTI SEMESTA",
                       "CITRA MAKMUR BINA SAHABAT HOOSEKI BUILDING. PT",
                       "CV. BELTECHINDO",
                       "CV. PRIMA TIMUR JAYA",
                       "DAITO ELEKTRINDO",
                       "DENKO WAHANA SAKTI ",
                       "DEXTRANS WORLWIDE INDONESIA. PT",
                       "ECONOMIE MANDIRI",
                       "ETIQA ASURANSI ",
                       "FEDEX EXPRESS INTERNATIONAL ",
                       "FFE LIMITED",
                       "GECA S.r.I",
                       "GENAIR NUSAINDO",
                       "GENAIR NUSAINDO ",
                       "HASEA CIPTA KARYA",
                       "HIKARI INDO SARANA. PT",
                       "HONEYWELL",
                       "HONEYWELL INDONESIA. PT",
                       "INTIKABEL METALINDO",
                       "ISTANA KEBON JERUK",
                       "KAMIL PUTRA PROTEKSINDO",
                       "KARYA GRAHA CAHAYA",
                       "KARYA GRAHA COMPUTER SUPERMALL",
                       "KIJANG SOLIDEO TEKNIK",
                       "LENTERA TILAS TEHNIK",
                       "MACRON SAFETY SYSTEMS (UK) LIMITED",
                       "MASTER INDO LOGISTICS. PT",
                       "MEDIA MITRA PRATAMA",
                       "METRO JAYA TEKNIK",
                       "MID SOLUSI NUSANTARA. PT",
                       "MITRA MAKMUR SOLUSINDO",
                       "MUHAMMAD FAIK",
                       "MULTRON SYSTEMS PTE. LTD",
                       "OBAY",
                       "PANAH PERDANA LOGISINDO. PT",
                       "PASKALIS ",
                       "PETRA CONDUIT",
                       "PRIMA TIMUR JAYA",
                       "PRIMA TUNGGAL JAVALAND",
                       "PROTOCONVERT",
                       "PT TUNAS RIDEAN",
                       "SETYA REKAT ABADI. PT",
                       "SHOPPE INDONESIA",
                       "TEKNIK MAKMUR MANDIRI",
                       "TEPG",
                       "TOKOPEDIA",
                       "VINOTI (VIVERE MULTI KREASI)",
                       "WIDJAJA TEKNIK UTAMA. PT",
                       "YANTO. BPK",
                       "TIRTA INVESTAMA. PT",
                       "FATHONA MARFAZRINA",
                       "HEBEI J&R TRADING CO. LTD",
                       "CAHAYA DELTA MANDIRI",
                       "PRIMACIPTA UNGGUL KARYA",
                       "DATA INTEGRASI SEMESTA",
                       "GLOBAL SECURITY SERVICE INDONESIA",
                       "BERKAH MANDIRI PROTECTION",
                       "PELOPOR PRATAMA LANCAR ABADI",
                       "BETA PANEL",
                       "WARUNG NASI PASUNDAN",
                       "LUBNA PERKASA ABADI",
                       "SIBALEC. PT",
                       "13ROTHER MAFIA KONVEKSI",
                       "UNI NETWORK COMMUNICATIONS",
                       "DENKO WAHANA SAKTI",
                       "ISS INDONESIA",
                       "HORING LIH INDUSTRIAL",
                       "AKARA DIRAYA NAWASENA",
                       "PANDU BINA SENTOSA",
                       "KSO SUCOFINDO - SURVEYOR INDONESIA",
                       "CV KARYA HADIAH KREATIF",
                       "ALFIRE PRIMA INDONEISA",
                       "CITRA INTI SEMESTA ",
                       "BAMBANG WINARNO. BPK",
                       "UMROTA KARYA UTAMA",
                       "KAP PIETER. UWAYS & REKAN",
                       "ELPRIMA KENCANA",
                       "BAHTERA BINA SELARAS",
                       "BINEX LOGISTIC",
                       "HOME CENTER INDONESIA RETAIL",
                       "BARAYA PROTEKSINDO ABADI", 
                       "ERAFONE ARTHA RETAILINDO",
                       "CV. AZZA BARAKAH SEJAHTERA",
                       "REJEKI PRIMA STEEL",
                       "SAMSIRA TEKNOLOGI INDONESIA",
                       "BINA GLOBAL TRANSPORT",
                       "ASENWARE INDONESIA JAYA",
                       "AZBIL BERCA INDONESIA",
                       "TEMAN BAIK. CV"
                    ];
                    
                    allVendorNames = sampleVendors;
                    // Simpan ke localStorage untuk pertama kali
                    localStorage.setItem('vendorList', JSON.stringify(allVendorNames));
                }
                
                setupVendorAutocomplete();
                
            } catch (error) {
                console.error("Error loading vendor data:", error);
                showAlert("Gagal memuat data vendor: " + error.message, 'error');
            }
        }

        // Function to add new vendor to the list
        function addNewVendor(vendorName) {
            if (!vendorName || vendorName.trim() === '') return false;
            
            const trimmedVendor = vendorName.trim();
            
            // Check if vendor already exists (case insensitive)
            const vendorExists = allVendorNames.some(vendor => 
                vendor.toLowerCase() === trimmedVendor.toLowerCase()
            );
            
            if (!vendorExists) {
                // Add new vendor to the beginning of the array
                allVendorNames.unshift(trimmedVendor);
                
                // Save updated list to localStorage
                localStorage.setItem('vendorList', JSON.stringify(allVendorNames));
                
                // Update autocomplete
                setupVendorAutocomplete();
                
                console.log("New vendor added:", trimmedVendor);
                return true;
            }
            
            return false;
        }

        // Setup vendor autocomplete
        function setupVendorAutocomplete() {
            const vendorInput = document.getElementById('invoice-nama-vendor');
            if (vendorInput && allVendorNames.length > 0) {
                autocomplete(vendorInput, allVendorNames, true);
            }
        }

        // Enhanced autocomplete function with add new vendor capability
        function autocomplete(inp, arr, allowNew = false) {
            let currentFocus;
            
            inp.addEventListener("input", function(e) {
                var a, b, i, val = this.value.trim();
                closeAllLists();
                
                // Don't show autocomplete if input is empty
                if (val.length < 1) { 
                    return false;
                }
                
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                
                let hasMatches = false;
                
                // Show matching vendors
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                        hasMatches = true;
                        b = document.createElement("DIV");
                        const matchIndex = arr[i].toUpperCase().indexOf(val.toUpperCase());
                        b.innerHTML = arr[i].substring(0, matchIndex) +
                            "<strong>" + arr[i].substring(matchIndex, matchIndex + val.length) + "</strong>" +
                            arr[i].substring(matchIndex + val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
                
                // Add "Add new vendor" option if no matches and allowNew is true
                if (!hasMatches && allowNew && val.length > 0) {
                    b = document.createElement("DIV");
                    b.className = "autocomplete-new-vendor";
                    b.innerHTML = "<i class='fas fa-plus-circle'></i> Tambah vendor baru: \"" + val + "\"";
                    b.innerHTML += "<input type='hidden' value='" + val + "'>";
                    b.addEventListener("click", function(e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                        // Automatically add the new vendor when selected
                        addNewVendor(val);
                        showAlert('Vendor baru "' + val + '" telah ditambahkan ke daftar', 'success');
                    });
                    a.appendChild(b);
                }
            });
            
            inp.addEventListener("keydown", function(e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) {
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    } else if (allowNew && this.value.trim().length > 0) {
                        // If no selection and allowNew, add the new vendor
                        const newVendor = this.value.trim();
                        if (addNewVendor(newVendor)) {
                            showAlert('Vendor baru "' + newVendor + '" telah ditambahkan ke daftar', 'success');
                        }
                    }
                }
            });
            
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }
            
            function removeActive(x) {
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        // --- Fungsi untuk membersihkan No Invoice agar aman digunakan sebagai ID dokumen Firestore ---
        function sanitizeInvoiceNo(invoiceNo) {
            return invoiceNo.replace(/\//g, '-');
        }

        // --- Calculate Status Based on Dates ---
        function calculateStatus(tglDiterima, jatuhTempo, tglBayar, currentStatus, isManualStatusFromDB) {
            // 1. Prioritas tertinggi: Jika sudah dibayar, statusnya 'Dibayar'
            if (tglBayar) {
                return 'Dibayar';
            }

            // 2. Jika status saat ini diatur secara manual (isManualStatusFromDB adalah true),
            //    maka pertahankan status manual tersebut.
            if (isManualStatusFromDB && currentStatus) {
                return currentStatus;
            }

            // 3. Jika belum dibayar dan bukan status manual yang dipertahankan,
            //    hitung status otomatis berdasarkan tanggal
            if (!tglDiterima || !jatuhTempo) {
                return currentStatus || 'Belum Diproses';
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const receivedDate = new Date(tglDiterima);
            receivedDate.setHours(0, 0, 0, 0);

            const dueDate = new Date(jatuhTempo);
            dueDate.setHours(0, 0, 0, 0);

            // Calculate 'Jatuh Tempo' (Overdue)
            if (today > dueDate) {
                return 'Jatuh Tempo';
            }

            // Calculate 'Menunggu Pembayaran' (3 days before due date)
            const threeDaysBeforeDueDate = new Date(dueDate);
            threeDaysBeforeDueDate.setDate(dueDate.getDate() - 3);
            threeDaysBeforeDueDate.setHours(0, 0, 0, 0);

            if (today >= threeDaysBeforeDueDate && today <= dueDate) {
                return 'Menunggu Pembayaran';
            }

            // Calculate 'Menunggu Pengajuan' (7 days before due date)
            const sevenDaysBeforeDueDate = new Date(dueDate);
            sevenDaysBeforeDueDate.setDate(dueDate.getDate() - 7);
            sevenDaysBeforeDueDate.setHours(0, 0, 0, 0);

            if (today >= sevenDaysBeforeDueDate && today < threeDaysBeforeDueDate) {
                return 'Menunggu Pengajuan';
            }

            return currentStatus || 'Belum Diproses';
        }

        // --- Render Invoices to Table (with pagination and filter) ---
        function renderInvoicesTable(data) {
            const invoiceTableBody = document.querySelector('#invoice-table tbody');
            if (!invoiceTableBody) return;

            invoiceTableBody.innerHTML = '';

            if (data.length === 0) {
                invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Tidak ada data invoice yang cocok.</td></tr>';
                renderPagination(0, 0);
                return;
            }

            const startIndex = (window.currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            let rowNum = startIndex + 1;
            const rowsHtml = [];

            paginatedData.forEach(invoice => {
                let statusClass = '';
                if (invoice.Status === 'Dibayar') statusClass = 'status-paid';
                else if (['Menunggu Pembayaran'].includes(invoice.Status)) statusClass = 'status-pending';
                else if (invoice.Status === 'Jatuh Tempo') statusClass = 'status-overdue';
                else if (['Diajukan ke Finance'].includes(invoice.Status)) statusClass = 'status-diajukan-finance';
                else if (['Diterima Anggi'].includes(invoice.Status)) statusClass = 'status-diterima-anggi';
                else if (['Dibatalkan'].includes(invoice.Status)) statusClass = 'status-dibatalkan';
                else if (['Menunggu Pengajuan', 'Belum Diproses'].includes(invoice.Status)) statusClass = 'status-menunggu-pengajuan';

                // Format DPP dan PPN
                let dppDisplay = 'N/A';
                let ppnDisplay = '';
                let currencyClass = '';
                let currencyText = '';
                
                if (invoice.DPP_IDR && invoice.DPP_IDR !== 'N/A' && invoice.DPP_IDR !== '0') {
                    dppDisplay = invoice.DPP_IDR;
                    if (invoice.PPn_IDR && invoice.PPn_IDR !== '0') {
                        ppnDisplay = `PPN: ${formatRupiah(invoice.PPn_IDR)}`;
                    }
                    currencyClass = 'currency-idr';
                    currencyText = 'IDR';
                } else if (invoice.DPP_USD && invoice.DPP_USD !== '0') {
                    dppDisplay = `$ ${invoice.DPP_USD}`;
                    currencyClass = 'currency-usd';
                    currencyText = 'USD';
                }

                rowsHtml.push(`
                    <tr data-invoice-id="${invoice.No_Invoice}">
                        <td>${rowNum++}</td>
                        <td>${invoice.Email_Hard || '-'}</td>
                        <td>${invoice.Penerima || '-'}</td>
                        <td>${invoice.Corp || '-'}</td>
                        <td>${invoice.Tanggal_Diterima || '-'}</td>
                        <td><a href="#" class="view-invoice-detail" data-invoice-no="${invoice.No_Invoice}">${invoice.No_Invoice}</a></td>
                        <td>${invoice.Nama_Vendor || '-'}</td>
                        <td>
                            <div class="dpp-ppn-container">
                                <div class="dpp-amount">${dppDisplay}</div>
                                ${ppnDisplay ? `<div class="ppn-amount">${ppnDisplay}</div>` : ''}
                            </div>
                            ${currencyText ? `<span class="currency-indicator ${currencyClass}">${currencyText}</span>` : ''}
                        </td>
                        <td>
                            <button class="status-button ${statusClass}" data-invoice-no="${invoice.No_Invoice}" data-current-status="${invoice.Status}">
                                ${invoice.Status}
                            </button>
                        </td>
                        <td class="action-cell">
                            <button class="action-btn edit-invoice-btn" data-invoice-no="${invoice.No_Invoice}" title="Edit Invoice"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-invoice-btn" data-invoice-no="${invoice.No_Invoice}" title="Hapus Invoice"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
            invoiceTableBody.innerHTML = rowsHtml.join('');
            renderPagination(data.length, window.currentPage);
        }

        // --- Render Pagination Controls ---
        function renderPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pageControls = document.querySelector('.pagination .page-controls');
            const pageInfo = document.querySelector('.pagination .page-info');
            pageControls.innerHTML = '';

            if (totalItems === 0) {
                pageInfo.textContent = 'Menampilkan 0-0 dari 0 data';
                return;
            }

            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            pageInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (window.currentPage > 1) {
                    window.currentPage--;
                    renderInvoicesTable(filteredInvoiceData);
                }
            });
            pageControls.appendChild(prevBtn);

            // Page numbers
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }

            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'page-btn';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => {
                    window.currentPage = 1;
                    renderInvoicesTable(filteredInvoiceData);
                });
                pageControls.appendChild(firstPageBtn);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pageControls.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    window.currentPage = i;
                    renderInvoicesTable(filteredInvoiceData);
                });
                pageControls.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pageControls.appendChild(dots);
                }
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'page-btn';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => {
                    window.currentPage = totalPages;
                    renderInvoicesTable(filteredInvoiceData);
                });
                pageControls.appendChild(lastPageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (window.currentPage < totalPages) {
                    window.currentPage++;
                    renderInvoicesTable(filteredInvoiceData);
                }
            });
            pageControls.appendChild(nextBtn);
        }

        // --- Load Invoices to Table (Initial Load and Refresh) ---
        async function loadInvoicesToTable() {
            const invoiceTableBody = document.querySelector('#invoice-table tbody');
            if (!invoiceTableBody) return;

            invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Memuat data...</td></tr>';
            allInvoiceNumbers = [];

            try {
                // Unsubscribe previous listener if exists
                if (window.invoiceUnsubscribe) {
                    window.invoiceUnsubscribe();
                }

                window.invoiceUnsubscribe = invoicesCol.onSnapshot(async (snapshot) => {
                    if (snapshot.empty) {
                        invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Tidak ada data invoice.</td></tr>';
                        allInvoiceNumbers = [];
                        allInvoiceData = [];
                        filteredInvoiceData = [];
                        renderPagination(0, 0);
                        return;
                    }

                    let rowNum = 1;
                    const currentAllInvoiceData = [];
                    const currentInvoiceNumbers = [];

                    // Fetch all related data once to optimize
                    const [pembayaranSnapshot, keteranganSnapshot] = await Promise.all([
                        pembayaranCol.get(),
                        keteranganCol.get()
                    ]);

                    const pembayaranMap = new Map();
                    pembayaranSnapshot.forEach(doc => {
                        pembayaranMap.set(doc.data().noInvoice, doc.data());
                    });

                    const keteranganMap = new Map();
                    keteranganSnapshot.forEach(doc => {
                        keteranganMap.set(doc.data().noInvoice, doc.data());
                    });

                    snapshot.forEach(doc => {
                        const invoice = doc.data();
                        const noInvoice = invoice.noInvoice;
                        currentInvoiceNumbers.push(noInvoice);

                        const pembayaran = pembayaranMap.get(noInvoice) || {};
                        const keterangan = keteranganMap.get(noInvoice) || {};

                        const dppDisplay = pembayaran.dppIdr ? formatRupiah(pembayaran.dppIdr) : 'N/A';
                        const ppnDisplay = pembayaran.ppnIdr ? formatRupiah(pembayaran.ppnIdr) : '0';
                        const statusDisplay = calculateStatus(
                            invoice.tglDiterima,
                            pembayaran.jatuhTempo,
                            keterangan.tglBayar,
                            keterangan.statusAkhir,
                            keterangan.isManualStatus || false
                        );
                        
                        currentAllInvoiceData.push({
                            No: rowNum++,
                            Email_Hard: invoice.emailHard || '',
                            Penerima: invoice.penerima || '',
                            Corp: invoice.corp || '',
                            Tanggal_Diterima: invoice.tglDiterima || '',
                            No_Invoice: noInvoice,
                            Nama_Vendor: invoice.namaVendor || '',
                            DPP_IDR: dppDisplay,
                            PPn_IDR: ppnDisplay,
                            DPP_USD: pembayaran.dppUsd || '0',
                            Keterangan_Pembayaran: pembayaran.keterangan || '',
                            Follow_Up: pembayaran.followUp || '',
                            Hasil_Follow_Up: pembayaran.hasilFollowUp || '',
                            TOP: pembayaran.top || '',
                            Jatuh_Tempo: pembayaran.jatuhTempo || '',
                            Tanggal_Pengajuan_Finance: keterangan.tglPengajuanFinance || '',
                            Tanggal_Pengajuan_Reni: keterangan.tglPengajuanReni || '',
                            Tanggal_Diterima_Anggi: keterangan.tglDiterimaAnggi || '',
                            Lama_Pengajuan: keterangan.lamaPengajuan || '',
                            Keterangan_Proses: keterangan.keteranganProses || '',
                            Tanggal_Bayar: keterangan.tglBayar || '',
                            Status: statusDisplay,
                            Is_Manual_Status: keterangan.isManualStatus || false
                        });
                    });
                    allInvoiceData = currentAllInvoiceData;
                    allInvoiceNumbers = currentInvoiceNumbers;
                    setupAllAutocompletes();
                    applyFilters();
                }, (error) => {
                    console.error("Error loading invoices: ", error);
                    invoiceTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: var(--danger);">Gagal memuat data: ${error.message}</td></tr>`;
                    showAlert("Gagal memuat data invoice: " + error.message, 'error');
                });
            } catch (error) {
                console.error("Error setting up invoice listener: ", error);
                invoiceTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: var(--danger);">Gagal memuat data: ${error.message}</td></tr>`;
                showAlert("Gagal memuat data invoice: " + error.message, 'error');
            }
        }

        // --- Apply Filters Function ---
        function applyFilters() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const statusFilter = document.getElementById('filter-status').value;
            const searchKeyword = document.getElementById('filter-search').value.toLowerCase();

            filteredInvoiceData = allInvoiceData.filter(invoice => {
                let matches = true;

                // Date filter (Tanggal Diterima)
                if (startDate && invoice.Tanggal_Diterima < startDate) {
                    matches = false;
                }
                if (endDate && invoice.Tanggal_Diterima > endDate) {
                    matches = false;
                }

                // Status filter
                if (statusFilter && statusFilter !== '' && invoice.Status !== statusFilter) {
                    matches = false;
                }

                // Keyword search (across multiple fields)
                if (searchKeyword) {
                    const searchableFields = [
                        invoice.No_Invoice,
                        invoice.Nama_Vendor,
                        invoice.Penerima,
                        invoice.Corp,
                        invoice.Status
                    ];
                    const keywordMatch = searchableFields.some(field =>
                        String(field).toLowerCase().includes(searchKeyword)
                    );
                    if (!keywordMatch) {
                        matches = false;
                    }
                }

                return matches;
            });

            window.currentPage = 1;
            renderInvoicesTable(filteredInvoiceData);
        }

        // --- Load Dashboard Data ---
        async function loadDashboardData() {
            const totalInvoiceEl = document.getElementById('dashboard-total-invoice');
            const paidInvoiceEl = document.getElementById('dashboard-paid-invoice');
            const pendingInvoiceEl = document.getElementById('dashboard-pending-invoice');
            const submissionPendingInvoiceEl = document.getElementById('dashboard-submission-pending-invoice');
            const overdueInvoiceEl = document.getElementById('dashboard-overdue-invoice');

            if (!totalInvoiceEl || !paidInvoiceEl || !pendingInvoiceEl || !overdueInvoiceEl || !submissionPendingInvoiceEl) return;

            totalInvoiceEl.textContent = '...';
            paidInvoiceEl.textContent = '...';
            pendingInvoiceEl.textContent = '...';
            submissionPendingInvoiceEl.textContent = '...';
            overdueInvoiceEl.textContent = '...';

            try {
                // Unsubscribe previous listener if exists
                if (window.dashboardUnsubscribe) {
                    window.dashboardUnsubscribe();
                }

                window.dashboardUnsubscribe = invoicesCol.onSnapshot(async (snapshot) => {
                    let total = 0;
                    let paid = 0;
                    let pending = 0;
                    let submissionPending = 0;
                    let overdue = 0;

                    if (!snapshot.empty) {
                        total = snapshot.size;
                        // Fetch all keterangan documents once to optimize
                        const [pembayaranSnapshot, keteranganSnapshot] = await Promise.all([
                            pembayaranCol.get(),
                            keteranganCol.get()
                        ]);

                        const pembayaranMap = new Map();
                        pembayaranSnapshot.forEach(doc => {
                            pembayaranMap.set(doc.data().noInvoice, doc.data());
                        });

                        const keteranganMap = new Map();
                        keteranganSnapshot.forEach(doc => {
                            keteranganMap.set(doc.data().noInvoice, doc.data());
                        });

                        snapshot.forEach(doc => {
                            const noInvoice = doc.data().noInvoice;
                            const invoiceData = doc.data();
                            const pembayaran = pembayaranMap.get(noInvoice) || {};
                            const keterangan = keteranganMap.get(noInvoice) || {};

                            const status = calculateStatus(
                                invoiceData.tglDiterima,
                                pembayaran.jatuhTempo,
                                keterangan.tglBayar,
                                keterangan.statusAkhir,
                                keterangan.isManualStatus || false
                            );

                            if (status === 'Dibayar') {
                                paid++;
                            } else if (status === 'Menunggu Pembayaran') {
                                pending++;
                            } else if (status === 'Menunggu Pengajuan') {
                                submissionPending++;
                            } else if (status === 'Jatuh Tempo') {
                                overdue++;
                            }
                        });
                    }

                    totalInvoiceEl.textContent = total;
                    paidInvoiceEl.textContent = paid;
                    pendingInvoiceEl.textContent = pending;
                    submissionPendingInvoiceEl.textContent = submissionPending;
                    overdueInvoiceEl.textContent = overdue;
                }, (error) => {
                    console.error("Error loading dashboard data: ", error);
                    showAlert("Gagal memuat data dashboard: " + error.message, 'error');
                    totalInvoiceEl.textContent = 'Error';
                    paidInvoiceEl.textContent = 'Error';
                    pendingInvoiceEl.textContent = 'Error';
                    submissionPendingInvoiceEl.textContent = 'Error';
                    overdueInvoiceEl.textContent = 'Error';
                });

            } catch (error) {
                console.error("Error setting up dashboard listener: ", error);
                showAlert("Gagal memuat data dashboard: " + error.message, 'error');
                totalInvoiceEl.textContent = 'Error';
                paidInvoiceEl.textContent = 'Error';
                pendingInvoiceEl.textContent = 'Error';
                submissionPendingInvoiceEl.textContent = 'Error';
                overdueInvoiceEl.textContent = 'Error';
            }
        }

        // Apply autocomplete to relevant input fields
        function setupAllAutocompletes() {
            const searchInvoiceFakturPajakInput = document.getElementById('search-invoice-faktur-pajak');
            const searchInvoicePembayaranInput = document.getElementById('search-invoice-pembayaran');
            const searchInvoiceKeteranganInput = document.getElementById('search-invoice-keterangan');
            const filterSearchInput = document.getElementById('filter-search');

            if (searchInvoiceFakturPajakInput) autocomplete(searchInvoiceFakturPajakInput, allInvoiceNumbers);
            if (searchInvoicePembayaranInput) autocomplete(searchInvoicePembayaranInput, allInvoiceNumbers);
            if (searchInvoiceKeteranganInput) autocomplete(searchInvoiceKeteranganInput, allInvoiceNumbers);
            if (filterSearchInput) autocomplete(filterSearchInput, allInvoiceNumbers);
        }

        // --- Format Rupiah Function ---
        function formatRupiah(angka, prefix = '') {
            let number_string = angka.toString().replace(/[^,\d]/g, ''),
                split = number_string.split(','),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);

            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }

            rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
            return prefix == undefined ? rupiah : (rupiah ? 'Rp ' + rupiah : '');
        }

        // --- Event Listener for Rupiah Input Formatting ---
        function setupRupiahInput(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                inputElement.addEventListener('keyup', function(e) {
                    inputElement.value = formatRupiah(this.value);
                });
                inputElement.addEventListener('blur', function(e) {
                    inputElement.value = formatRupiah(this.value);
                });
            }
        }

        // --- Fungsi untuk menghitung PPN otomatis ---
        function calculatePPN() {
            const dppIdrInput = document.getElementById('pembayaran-dpp-idr');
            const ppnIdrInput = document.getElementById('pembayaran-ppn-idr');
            const includePPNCheckbox = document.getElementById('pembayaran-include-ppn');
            
            if (!dppIdrInput || !ppnIdrInput || !includePPNCheckbox) return;
            
            const dppValue = dppIdrInput.value.replace(/[^0-9]/g, '');
            
            if (dppValue && includePPNCheckbox.checked) {
                const dppNumber = parseInt(dppValue);
                const ppnAmount = Math.round(dppNumber * 0.11);
                ppnIdrInput.value = formatRupiah(ppnAmount.toString());
            } else if (includePPNCheckbox.checked === false) {
                // Tidak mengosongkan PPN jika diketik manual
                // Hanya kosongkan jika nilainya sama dengan hasil kalkulasi otomatis
                const currentPPNValue = ppnIdrInput.value.replace(/[^0-9]/g, '');
                const calculatedPPN = Math.round(parseInt(dppValue || 0) * 0.11);
                
                if (currentPPNValue === calculatedPPN.toString()) {
                    ppnIdrInput.value = '';
                }
            }
        }

        // --- Improved Login Functionality ---
        function initLogin() {
            const loginForm = document.getElementById('login-form');
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');

            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }

            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in, hide login and show main content
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('main-container').style.display = 'flex';
                    // Load semua data yang diperlukan saat login berhasil
                    loadDashboardData();
                    loadVendorData();
                    loadInvoicesToTable();
                    // Tampilkan dashboard secara otomatis
                    showSection('dashboard-section');
                } else {
                    // User is signed out, show login
                    document.getElementById('auth-container').style.display = 'flex';
                    document.getElementById('main-container').style.display = 'none';
                }
            });
        }

        function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');

            // Show loading state
            loginBtn.classList.add('loading');
            loginError.style.display = 'none';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login successful
                    loginBtn.classList.remove('loading');
                    showAlert('Login berhasil!', 'success');
                })
                .catch((error) => {
                    // Login failed
                    loginBtn.classList.remove('loading');
                    loginError.textContent = error.message;
                    loginError.style.display = 'block';
                    console.error("Login error:", error);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                showAlert('Logout berhasil!', 'success');
            }).catch((error) => {
                console.error("Logout error:", error);
            });
        }

        // --- Status Summary Modal Functions ---
        function openStatusSummaryModal(statusType) {
            const modal = document.getElementById('status-summary-modal');
            const title = document.getElementById('status-summary-title');
            const tableBody = document.querySelector('#status-summary-table tbody');
            
            // Set title based on status type
            let statusText = '';
            switch(statusType) {
                case 'total':
                    statusText = 'Total Invoice';
                    break;
                case 'paid':
                    statusText = 'Invoice Telah Dibayar';
                    break;
                case 'pending':
                    statusText = 'Invoice Menunggu Pembayaran';
                    break;
                case 'submission-pending':
                    statusText = 'Invoice Menunggu Pengajuan';
                    break;
                case 'overdue':
                    statusText = 'Invoice Jatuh Tempo';
                    break;
                default:
                    statusText = 'Invoice';
            }
            
            title.textContent = `Daftar ${statusText}`;
            
            // Filter data based on status type
            let filteredData = [];
            switch(statusType) {
                case 'total':
                    filteredData = allInvoiceData;
                    break;
                case 'paid':
                    filteredData = allInvoiceData.filter(invoice => invoice.Status === 'Dibayar');
                    break;
                case 'pending':
                    filteredData = allInvoiceData.filter(invoice => invoice.Status === 'Menunggu Pembayaran');
                    break;
                case 'submission-pending':
                    filteredData = allInvoiceData.filter(invoice => invoice.Status === 'Menunggu Pengajuan');
                    break;
                case 'overdue':
                    filteredData = allInvoiceData.filter(invoice => invoice.Status === 'Jatuh Tempo');
                    break;
                default:
                    filteredData = allInvoiceData;
            }
            
            // Render table rows
            tableBody.innerHTML = '';
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada data.</td></tr>';
            } else {
                filteredData.forEach((invoice, index) => {
                    let statusClass = '';
                    if (invoice.Status === 'Dibayar') statusClass = 'status-paid';
                    else if (['Menunggu Pembayaran'].includes(invoice.Status)) statusClass = 'status-pending';
                    else if (invoice.Status === 'Jatuh Tempo') statusClass = 'status-overdue';
                    else if (['Diajukan ke Finance'].includes(invoice.Status)) statusClass = 'status-diajukan-finance';
                    else if (['Diterima Anggi'].includes(invoice.Status)) statusClass = 'status-diterima-anggi';
                    else if (['Dibatalkan'].includes(invoice.Status)) statusClass = 'status-dibatalkan';
                    else if (['Menunggu Pengajuan', 'Belum Diproses'].includes(invoice.Status)) statusClass = 'status-menunggu-pengajuan';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${invoice.No_Invoice}</td>
                        <td>${invoice.Nama_Vendor || '-'}</td>
                        <td>${invoice.DPP_IDR || '-'}</td>
                        <td><span class="status-button ${statusClass}">${invoice.Status}</span></td>
                        <td class="keterangan-proses-cell">${invoice.Keterangan_Proses || '-'}</td>
                        <td>${invoice.Jatuh_Tempo || '-'}</td>
                        <td>${invoice.Tanggal_Bayar || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // Show modal
            modal.style.display = 'flex';
        }

        function closeStatusSummaryModal() {
            document.getElementById('status-summary-modal').style.display = 'none';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initLogin();
            
            const contentSections = document.querySelectorAll('.content-section');
            const navItems = document.querySelectorAll('.nav-item');
            const invoiceTableBody = document.querySelector('#invoice-table tbody');
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');

            // --- Sidebar Toggle Functionality ---
            function toggleSidebar() {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }

            const savedSidebarState = localStorage.getItem('sidebarCollapsed');
            if (savedSidebarState === 'true') {
                sidebar.classList.add('collapsed');
            }

            if (sidebarToggleBtn) {
                sidebarToggleBtn.addEventListener('click', toggleSidebar);
            }

            // --- Fungsi Navigasi Sidebar ---
            function showSection(targetId) {
                contentSections.forEach(section => {
                    section.style.display = 'none';
                });
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                }

                navItems.forEach(item => item.classList.remove('active'));
                const activeNavItem = document.querySelector(`.nav-item[data-target="${targetId}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }
            }
            window.showSection = showSection;

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.dataset.target;
                    if (targetId) {
                        showSection(targetId);
                    } else if (this.id === 'logout-btn') {
                        auth.signOut().then(() => {
                            showAlert('Anda telah logout.', 'info');
                        }).catch((error) => {
                            console.error("Error logging out: ", error);
                            showAlert("Gagal logout: " + error.message, 'error');
                        });
                    }
                });
            });

            // --- Modals Functionality ---
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('.modal-close-btn');

            function resetModalForm(modalId) {
                const form = document.getElementById(modalId.replace('-modal', '-form'));
                if (form) {
                    form.reset();
                    const noInvoiceInput = form.querySelector('input[id$="-no-invoice"]');
                    if (noInvoiceInput) noInvoiceInput.readOnly = false;
                    const autocompleteLists = form.querySelectorAll('.autocomplete-items');
                    autocompleteLists.forEach(list => {
                        if (list.parentNode) list.parentNode.removeChild(list);
                    });
                    
                    // Reset checkbox PPN
                    const includePPNCheckbox = document.getElementById('pembayaran-include-ppn');
                    if (includePPNCheckbox) {
                        includePPNCheckbox.checked = false;
                    }
                }
            }

            // Override openModal to handle fetching tglDiterima for pembayaran-modal
            window.openModal = async function(modalId, rawInvoiceNo = null) {
                const modal = document.getElementById(modalId);
                resetModalForm(modalId);
                modal.style.display = 'flex';

                if (rawInvoiceNo) {
                    const invoiceNoDocId = sanitizeInvoiceNo(rawInvoiceNo);
                    const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                    if (invoiceDoc.exists) {
                        const invoiceData = invoiceDoc.data();
                        const noInvoiceInput = modal.querySelector(`input[id$="-no-invoice"]`);
                        if (noInvoiceInput) {
                            noInvoiceInput.value = rawInvoiceNo;
                            noInvoiceInput.readOnly = true;
                        }
                        await fillModalWithExistingData(modalId, rawInvoiceNo);

                        if (modalId === 'pembayaran-modal') {
                            const tempInvoiceTglDiterimaInput = document.getElementById('invoice-tgl-diterima');
                            if (tempInvoiceTglDiterimaInput) {
                                tempInvoiceTglDiterimaInput.value = invoiceData.tglDiterima || '';
                            }
                            calculateJatuhTempo();
                        }
                    } else {
                        showAlert('Invoice tidak ditemukan untuk No Invoice ini.', 'error');
                        closeModal(modalId);
                    }
                }
            };

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
                resetModalForm(modalId);
            }

            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    closeModal(this.closest('.modal').id);
                });
            });

            window.addEventListener('click', function(event) {
                modals.forEach(modal => {
                    if (event.target == modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // --- Invoice Modal Specifics ---
            document.getElementById('add-invoice-btn').addEventListener('click', function() {
                window.openModal('invoice-modal');
                document.getElementById('invoice-no-invoice').readOnly = false;
                document.getElementById('invoice-no-invoice').value = '';
            });

            document.getElementById('invoice-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const rawNoInvoice = document.getElementById('invoice-no-invoice').value.trim();
                if (!rawNoInvoice) {
                    showAlert('No Invoice tidak boleh kosong.', 'error');
                    return;
                }
                const noInvoiceDocId = sanitizeInvoiceNo(rawNoInvoice);

                const vendorName = document.getElementById('invoice-nama-vendor').value.trim();
                if (vendorName) {
                    // Automatically add new vendor if it doesn't exist
                    addNewVendor(vendorName);
                }

                const formData = {
                    emailHard: document.getElementById('invoice-email-hard').value,
                    penerima: document.getElementById('invoice-penerima').value,
                    corp: document.getElementById('invoice-corp').value,
                    tglDiterima: document.getElementById('invoice-tgl-diterima').value,
                    tglInvoice: document.getElementById('invoice-tgl-invoice').value,
                    suratJalan: document.getElementById('invoice-surat-jalan').value,
                    namaVendor: vendorName,
                    noInvoice: rawNoInvoice,
                };

                try {
                    await invoicesCol.doc(noInvoiceDocId).set(formData, { merge: true });
                    showAlert('Invoice berhasil disimpan!', 'success');
                    closeModal('invoice-modal');
                    
                    // Simpan halaman saat ini sebelum refresh
                    const currentPageBeforeRefresh = window.currentPage;
                    
                    // Refresh data dengan mempertahankan halaman saat ini
                    if (window.invoiceUnsubscribe) {
                        window.invoiceUnsubscribe();
                    }
                    
                    // Set up listener baru untuk data terbaru
                    window.invoiceUnsubscribe = invoicesCol.onSnapshot(async (snapshot) => {
                        if (snapshot.empty) {
                            allInvoiceData = [];
                            filteredInvoiceData = [];
                            renderInvoicesTable(filteredInvoiceData);
                            return;
                        }

                        let rowNum = 1;
                        const currentAllInvoiceData = [];
                        const currentInvoiceNumbers = [];

                        // Fetch all related data once to optimize
                        const [pembayaranSnapshot, keteranganSnapshot] = await Promise.all([
                            pembayaranCol.get(),
                            keteranganCol.get()
                        ]);

                        const pembayaranMap = new Map();
                        pembayaranSnapshot.forEach(doc => {
                            pembayaranMap.set(doc.data().noInvoice, doc.data());
                        });

                        const keteranganMap = new Map();
                        keteranganSnapshot.forEach(doc => {
                            keteranganMap.set(doc.data().noInvoice, doc.data());
                        });

                        snapshot.forEach(doc => {
                            const invoice = doc.data();
                            const noInvoice = invoice.noInvoice;
                            currentInvoiceNumbers.push(noInvoice);

                            const pembayaran = pembayaranMap.get(noInvoice) || {};
                            const keterangan = keteranganMap.get(noInvoice) || {};

                            const dppDisplay = pembayaran.dppIdr ? formatRupiah(pembayaran.dppIdr) : 'N/A';
                            const ppnDisplay = pembayaran.ppnIdr ? formatRupiah(pembayaran.ppnIdr) : '0';
                            const statusDisplay = calculateStatus(
                                invoice.tglDiterima,
                                pembayaran.jatuhTempo,
                                keterangan.tglBayar,
                                keterangan.statusAkhir,
                                keterangan.isManualStatus || false
                            );
                            
                            currentAllInvoiceData.push({
                                No: rowNum++,
                                Email_Hard: invoice.emailHard || '',
                                Penerima: invoice.penerima || '',
                                Corp: invoice.corp || '',
                                Tanggal_Diterima: invoice.tglDiterima || '',
                                No_Invoice: noInvoice,
                                Nama_Vendor: invoice.namaVendor || '',
                                DPP_IDR: dppDisplay,
                                PPn_IDR: ppnDisplay,
                                DPP_USD: pembayaran.dppUsd || '0',
                                Keterangan_Pembayaran: pembayaran.keterangan || '',
                                Follow_Up: pembayaran.followUp || '',
                                Hasil_Follow_Up: pembayaran.hasilFollowUp || '',
                                TOP: pembayaran.top || '',
                                Jatuh_Tempo: pembayaran.jatuhTempo || '',
                                Tanggal_Pengajuan_Finance: keterangan.tglPengajuanFinance || '',
                                Tanggal_Pengajuan_Reni: keterangan.tglPengajuanReni || '',
                                Tanggal_Diterima_Anggi: keterangan.tglDiterimaAnggi || '',
                                Lama_Pengajuan: keterangan.lamaPengajuan || '',
                                Keterangan_Proses: keterangan.keteranganProses || '',
                                Tanggal_Bayar: keterangan.tglBayar || '',
                                Status: statusDisplay,
                                Is_Manual_Status: keterangan.isManualStatus || false
                            });
                        });
                        allInvoiceData = currentAllInvoiceData;
                        allInvoiceNumbers = currentInvoiceNumbers;
                        setupAllAutocompletes();
                        
                        // Terapkan filter dan render dengan halaman yang sama
                        applyFilters();
                        window.currentPage = currentPageBeforeRefresh;
                        renderInvoicesTable(filteredInvoiceData);
                    });
                } catch (error) {
                    console.error("Error saving invoice: ", error);
                    showAlert("Gagal menyimpan invoice: " + error.message, 'error');
                }
            });

            // --- View Invoice Detail Functionality ---
            async function displayInvoiceDetail(rawInvoiceNo) {
                const invoiceNoDocId = sanitizeInvoiceNo(rawInvoiceNo);
                const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                if (!invoiceDoc.exists) {
                    showAlert('Data invoice tidak ditemukan.', 'error');
                    return;
                }
                const data = invoiceDoc.data();

                const fpQuery = await fakturPajakCol.where('noInvoice', '==', rawInvoiceNo).limit(1).get();
                const fpData = fpQuery.empty ? {} : fpQuery.docs[0].data();

                const pembayaranQuery = await pembayaranCol.where('noInvoice', '==', rawInvoiceNo).limit(1).get();
                const pembayaranData = pembayaranQuery.empty ? {} : pembayaranQuery.docs[0].data();

                const keteranganQuery = await keteranganCol.where('noInvoice', '==', rawInvoiceNo).limit(1).get();
                const keterangan = keteranganQuery.empty ? {} : keteranganQuery.docs[0].data();

                const calculatedStatus = calculateStatus(
                    data.tglDiterima,
                    pembayaranData.jatuhTempo,
                    keterangan.tglBayar,
                    keterangan.statusAkhir,
                    keterangan.isManualStatus || false
                );

                contentSections.forEach(section => section.style.display = 'none');
                document.getElementById('invoice-detail-section').style.display = 'block';
                document.getElementById('detail-invoice-no').textContent = rawInvoiceNo;

                document.getElementById('detail-email-hard').textContent = data.emailHard || '-';
                document.getElementById('detail-penerima').textContent = data.penerima || '-';
                document.getElementById('detail-corp').textContent = data.corp || '-';
                document.getElementById('detail-tgl-diterima').textContent = data.tglDiterima || '-';
                document.getElementById('detail-tgl-invoice').textContent = data.tglInvoice || '-';
                document.getElementById('detail-surat-jalan').textContent = data.suratJalan || '-';
                document.getElementById('detail-nama-vendor').textContent = data.namaVendor || '-';

                document.getElementById('detail-no-faktur-pajak').textContent = fpData.noFakturPajak || 'Belum ada';
                document.getElementById('detail-tgl-faktur-pajak').textContent = fpData.tglFakturPajak || 'Belum ada';
                document.getElementById('add-edit-faktur-pajak-btn').dataset.invoiceNo = rawInvoiceNo;

                // Tampilkan DPP yang sudah termasuk PPN jika ada
                let dppDisplay = 'Rp 0';
                if (pembayaranData.dppIdr) {
                    if (pembayaranData.includePPN) {
                        // Jika include PPN, tampilkan total (DPP + PPN)
                        const totalWithPPN = parseInt(pembayaranData.dppIdr) + parseInt(pembayaranData.ppnIdr || 0);
                        dppDisplay = formatRupiah(totalWithPPN);
                    } else {
                        // Jika tidak include PPN, tampilkan DPP saja
                        dppDisplay = formatRupiah(pembayaranData.dppIdr);
                    }
                }

                document.getElementById('detail-dpp-idr').textContent = dppDisplay;
                document.getElementById('detail-ppn-idr').textContent = pembayaranData.ppnIdr ? `Rp ${formatRupiah(pembayaranData.ppnIdr)}` : 'Rp 0';
                document.getElementById('detail-dpp-usd').textContent = `$ ${pembayaranData.dppUsd || '0.00'}`;
                document.getElementById('detail-keterangan-pembayaran').textContent = pembayaranData.keterangan || '-';
                document.getElementById('detail-follow-up').textContent = pembayaranData.followUp || '-';
                document.getElementById('detail-hasil-follow-up').textContent = pembayaranData.hasilFollowUp || '-';
                document.getElementById('detail-top').textContent = pembayaranData.top || '-';
                document.getElementById('detail-jatuh-tempo').textContent = pembayaranData.jatuhTempo || '-';
                document.getElementById('add-edit-pembayaran-btn').dataset.invoiceNo = rawInvoiceNo;

                document.getElementById('detail-tgl-pengajuan-finance').textContent = keterangan.tglPengajuanFinance || '-';
                document.getElementById('detail-tgl-pengajuan-reni').textContent = keterangan.tglPengajuanReni || '-';
                document.getElementById('detail-tgl-diterima-anggi').textContent = keterangan.tglDiterimaAnggi || '-';
                document.getElementById('detail-lama-pengajuan').textContent = keterangan.lamaPengajuan || '-';
                document.getElementById('detail-keterangan-proses').textContent = keterangan.keteranganProses || '-';
                document.getElementById('detail-tgl-bayar').textContent = keterangan.tglBayar || '-';
                document.getElementById('detail-status-akhir').textContent = calculatedStatus || '-';
                document.getElementById('add-edit-keterangan-btn').dataset.invoiceNo = rawInvoiceNo;

                document.getElementById('edit-full-invoice-btn').dataset.invoiceNo = rawInvoiceNo;
            }

            // Event listeners for viewing invoice details
            if (invoiceTableBody) {
                invoiceTableBody.addEventListener('click', function(e) {
                    const targetLink = e.target.closest('.view-invoice-detail');
                    if (targetLink) {
                        e.preventDefault();
                        const invoiceNo = targetLink.dataset.invoiceNo;
                        displayInvoiceDetail(invoiceNo);
                    }

                    const editBtn = e.target.closest('.edit-invoice-btn');
                    if (editBtn) {
                        e.preventDefault();
                        const invoiceNo = editBtn.dataset.invoiceNo;
                        editInvoiceFromTable(invoiceNo);
                    }

                    const deleteBtn = e.target.closest('.delete-invoice-btn');
                    if (deleteBtn) {
                        e.preventDefault();
                        const invoiceNo = deleteBtn.dataset.invoiceNo;
                        deleteInvoice(invoiceNo);
                    }

                    const statusButton = e.target.closest('.status-button');
                    if (statusButton) {
                        e.preventDefault();
                        const invoiceNo = statusButton.dataset.invoiceNo;
                        const currentStatus = statusButton.dataset.currentStatus;
                        openStatusModal(invoiceNo, currentStatus);
                    }
                });
            }

            // Function to edit Invoice from table
            async function editInvoiceFromTable(rawInvoiceNo) {
                const invoiceNoDocId = sanitizeInvoiceNo(rawInvoiceNo);
                const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                if (invoiceDoc.exists) {
                    const invoiceData = invoiceDoc.data();
                    window.openModal('invoice-modal', rawInvoiceNo);
                    document.getElementById('invoice-no-invoice').readOnly = true;
                    document.getElementById('invoice-email-hard').value = invoiceData.emailHard || '';
                    document.getElementById('invoice-penerima').value = invoiceData.penerima || '';
                    document.getElementById('invoice-corp').value = invoiceData.corp || '';
                    document.getElementById('invoice-tgl-diterima').value = invoiceData.tglDiterima || '';
                    document.getElementById('invoice-tgl-invoice').value = invoiceData.tglInvoice || '';
                    document.getElementById('invoice-surat-jalan').value = invoiceData.suratJalan || '';
                    document.getElementById('invoice-nama-vendor').value = invoiceData.namaVendor || '';
                    document.getElementById('invoice-no-invoice').value = invoiceData.noInvoice || '';
                } else {
                    showAlert('Invoice tidak ditemukan.', 'error');
                }
            }

            // Function to delete Invoice
            async function deleteInvoice(rawInvoiceNo) {
                const userConfirmed = window.confirm(`Apakah Anda yakin ingin menghapus invoice dengan No Invoice: ${rawInvoiceNo}? Ini akan menghapus semua data terkait (Faktur Pajak, Pembayaran, Keterangan).`);

                if (!userConfirmed) {
                    showAlert('Penghapusan invoice dibatalkan.', 'info');
                    return;
                }

                const invoiceNoDocId = sanitizeInvoiceNo(rawInvoiceNo);

                try {
                    await invoicesCol.doc(invoiceNoDocId).delete();

                    const fpDocs = await fakturPajakCol.where('noInvoice', '==', rawInvoiceNo).get();
                    const fpBatch = db.batch();
                    fpDocs.forEach(doc => fpBatch.delete(doc.ref));
                    await fpBatch.commit();

                    const pembayaranDocs = await pembayaranCol.where('noInvoice', '==', rawInvoiceNo).get();
                    const pembayaranBatch = db.batch();
                    pembayaranDocs.forEach(doc => pembayaranBatch.delete(doc.ref));
                    await pembayaranBatch.commit();

                    const keteranganDocs = await keteranganCol.where('noInvoice', '==', rawInvoiceNo).get();
                    const keteranganBatch = db.batch();
                    keteranganDocs.forEach(doc => keteranganBatch.delete(doc.ref));
                    await keteranganBatch.commit();

                    showAlert('Invoice dan data terkait berhasil dihapus!', 'success');
                    
                    // Tetap di halaman yang sama setelah hapus
                    const currentPageBeforeDelete = window.currentPage;
                    
                    // Refresh data dengan mempertahankan halaman saat ini
                    if (window.invoiceUnsubscribe) {
                        window.invoiceUnsubscribe();
                    }
                    
                    // Set up listener baru untuk data terbaru
                    window.invoiceUnsubscribe = invoicesCol.onSnapshot(async (snapshot) => {
                        if (snapshot.empty) {
                            allInvoiceData = [];
                            filteredInvoiceData = [];
                            renderInvoicesTable(filteredInvoiceData);
                            return;
                        }

                        let rowNum = 1;
                        const currentAllInvoiceData = [];
                        const currentInvoiceNumbers = [];

                        // Fetch all related data once to optimize
                        const [pembayaranSnapshot, keteranganSnapshot] = await Promise.all([
                            pembayaranCol.get(),
                            keteranganCol.get()
                        ]);

                        const pembayaranMap = new Map();
                        pembayaranSnapshot.forEach(doc => {
                            pembayaranMap.set(doc.data().noInvoice, doc.data());
                        });

                        const keteranganMap = new Map();
                        keteranganSnapshot.forEach(doc => {
                            keteranganMap.set(doc.data().noInvoice, doc.data());
                        });

                        snapshot.forEach(doc => {
                            const invoice = doc.data();
                            const noInvoice = invoice.noInvoice;
                            currentInvoiceNumbers.push(noInvoice);

                            const pembayaran = pembayaranMap.get(noInvoice) || {};
                            const keterangan = keteranganMap.get(noInvoice) || {};

                            const dppDisplay = pembayaran.dppIdr ? formatRupiah(pembayaran.dppIdr) : 'N/A';
                            const ppnDisplay = pembayaran.ppnIdr ? formatRupiah(pembayaran.ppnIdr) : '0';
                            const statusDisplay = calculateStatus(
                                invoice.tglDiterima,
                                pembayaran.jatuhTempo,
                                keterangan.tglBayar,
                                keterangan.statusAkhir,
                                keterangan.isManualStatus || false
                            );
                            
                            currentAllInvoiceData.push({
                                No: rowNum++,
                                Email_Hard: invoice.emailHard || '',
                                Penerima: invoice.penerima || '',
                                Corp: invoice.corp || '',
                                Tanggal_Diterima: invoice.tglDiterima || '',
                                No_Invoice: noInvoice,
                                Nama_Vendor: invoice.namaVendor || '',
                                DPP_IDR: dppDisplay,
                                PPn_IDR: ppnDisplay,
                                DPP_USD: pembayaran.dppUsd || '0',
                                Keterangan_Pembayaran: pembayaran.keterangan || '',
                                Follow_Up: pembayaran.followUp || '',
                                Hasil_Follow_Up: pembayaran.hasilFollowUp || '',
                                TOP: pembayaran.top || '',
                                Jatuh_Tempo: pembayaran.jatuhTempo || '',
                                Tanggal_Pengajuan_Finance: keterangan.tglPengajuanFinance || '',
                                Tanggal_Pengajuan_Reni: keterangan.tglPengajuanReni || '',
                                Tanggal_Diterima_Anggi: keterangan.tglDiterimaAnggi || '',
                                Lama_Pengajuan: keterangan.lamaPengajuan || '',
                                Keterangan_Proses: keterangan.keteranganProses || '',
                                Tanggal_Bayar: keterangan.tglBayar || '',
                                Status: statusDisplay,
                                Is_Manual_Status: keterangan.isManualStatus || false
                            });
                        });
                        allInvoiceData = currentAllInvoiceData;
                        allInvoiceNumbers = currentInvoiceNumbers;
                        setupAllAutocompletes();
                        
                        // Terapkan filter dan render dengan halaman yang sama
                        applyFilters();
                        window.currentPage = currentPageBeforeDelete;
                        renderInvoicesTable(filteredInvoiceData);
                    });
                } catch (error) {
                    console.error("Error deleting invoice: ", error);
                    showAlert("Gagal menghapus invoice: " + error.message, 'error');
                }
            }

            document.getElementById('back-to-list-btn').addEventListener('click', function() {
                showSection('invoice-list-section');
            });

            // --- Edit Invoice from Detail Page ---
            document.getElementById('edit-full-invoice-btn').addEventListener('click', async function() {
                const rawInvoiceNo = this.dataset.invoiceNo;
                const invoiceNoDocId = sanitizeInvoiceNo(rawInvoiceNo);
                const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                if (invoiceDoc.exists) {
                    const invoiceData = invoiceDoc.data();
                    window.openModal('invoice-modal', rawInvoiceNo);
                    document.getElementById('invoice-no-invoice').readOnly = true;
                    document.getElementById('invoice-email-hard').value = invoiceData.emailHard || '';
                    document.getElementById('invoice-penerima').value = invoiceData.penerima || '';
                    document.getElementById('invoice-corp').value = invoiceData.corp || '';
                    document.getElementById('invoice-tgl-diterima').value = invoiceData.tglDiterima || '';
                    document.getElementById('invoice-tgl-invoice').value = invoiceData.tglInvoice || '';
                    document.getElementById('invoice-surat-jalan').value = invoiceData.suratJalan || '';
                    document.getElementById('invoice-nama-vendor').value = invoiceData.namaVendor || '';
                    document.getElementById('invoice-no-invoice').value = invoiceData.noInvoice || '';
                } else {
                    showAlert('Invoice tidak ditemukan.', 'error');
                }
            });

            // --- Modals for Faktur Pajak, Pembayaran, Keterangan (from Detail Page) ---
            document.getElementById('add-edit-faktur-pajak-btn').addEventListener('click', function() {
                window.openModal('faktur-pajak-modal', this.dataset.invoiceNo);
            });
            document.getElementById('add-edit-pembayaran-btn').addEventListener('click', function() {
                window.openModal('pembayaran-modal', this.dataset.invoiceNo);
            });
            document.getElementById('add-edit-keterangan-btn').addEventListener('click', function() {
                window.openModal('keterangan-modal', this.dataset.invoiceNo);
            });

            // --- Standalone Modals for Faktur Pajak, Pembayaran, Keterangan (from Sidebar) ---
            document.getElementById('add-faktur-pajak-standalone-btn').addEventListener('click', function() {
                window.openModal('faktur-pajak-modal');
                document.getElementById('fp-no-invoice').readOnly = false;
                document.getElementById('fp-no-invoice').value = '';
            });
            document.getElementById('add-pembayaran-standalone-btn').addEventListener('click', function() {
                window.openModal('pembayaran-modal');
                document.getElementById('pembayaran-no-invoice').readOnly = false;
                document.getElementById('pembayaran-no-invoice').value = '';
            });
            document.getElementById('add-keterangan-standalone-btn').addEventListener('click', function() {
                window.openModal('keterangan-modal');
                document.getElementById('keterangan-no-invoice').readOnly = false;
                document.getElementById('keterangan-no-invoice').value = '';
            });

            // --- Search functionality for standalone modals ---
            function setupSearchAndFillModal(searchBtnId, searchInputId, modalId) {
                const searchBtn = document.getElementById(searchBtnId);
                const searchInput = document.getElementById(searchInputId);

                if (searchBtn && searchInput) {
                    searchBtn.addEventListener('click', async function() {
                        const rawInvoiceNo = searchInput.value.trim();
                        if (rawInvoiceNo) {
                            const invoiceNoDocId = sanitizeInvoiceNo(rawInvoiceNo);
                            const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                            if (invoiceDoc.exists) {
                                window.openModal(modalId, rawInvoiceNo);
                            } else {
                                showAlert('No Invoice tidak ditemukan. Silakan input data invoice terlebih dahulu.', 'error');
                            }
                        } else {
                            showAlert('Harap masukkan No Invoice.', 'info');
                        }
                    });
                }
            }

            setupSearchAndFillModal('search-faktur-pajak-btn', 'search-invoice-faktur-pajak', 'faktur-pajak-modal');
            setupSearchAndFillModal('search-pembayaran-btn', 'search-invoice-pembayaran', 'pembayaran-modal');
            setupSearchAndFillModal('search-keterangan-btn', 'search-invoice-keterangan', 'keterangan-modal');

            // --- Fill Modal with Existing Data (for edit) ---
            async function fillModalWithExistingData(modalId, rawInvoiceNo) {
                let dataToFill = {};
                let collectionRef;

                switch (modalId) {
                    case 'faktur-pajak-modal':
                        collectionRef = fakturPajakCol;
                        break;
                    case 'pembayaran-modal':
                        collectionRef = pembayaranCol;
                        break;
                    case 'keterangan-modal':
                        collectionRef = keteranganCol;
                        break;
                    case 'status-modal':
                        collectionRef = keteranganCol;
                        break;
                    default:
                        return;
                }

                const existingDocQuery = await collectionRef.where('noInvoice', '==', rawInvoiceNo).limit(1).get();
                if (!existingDocQuery.empty) {
                    dataToFill = existingDocQuery.docs[0].data();
                }

                switch (modalId) {
                    case 'faktur-pajak-modal':
                        document.getElementById('fp-tgl-faktur-pajak').value = dataToFill.tglFakturPajak || '';
                        document.getElementById('fp-no-faktur-pajak').value = dataToFill.noFakturPajak || '';
                        break;
                    case 'pembayaran-modal':
                        document.getElementById('pembayaran-dpp-idr').value = formatRupiah(dataToFill.dppIdr || '');
                        document.getElementById('pembayaran-ppn-idr').value = formatRupiah(dataToFill.ppnIdr || '');
                        document.getElementById('pembayaran-dpp-usd').value = dataToFill.dppUsd || '';
                        document.getElementById('pembayaran-keterangan').value = dataToFill.keterangan || '';
                        document.getElementById('pembayaran-follow-up').value = dataToFill.followUp || 'Tidak';
                        document.getElementById('pembayaran-hasil-follow-up').value = dataToFill.hasilFollowUp || '';
                        document.getElementById('pembayaran-top').value = dataToFill.top || '';
                        document.getElementById('pembayaran-jatuh-tempo').value = dataToFill.jatuhTempo || '';
                        
                        // Set checkbox PPN
                        const includePPNCheckbox = document.getElementById('pembayaran-include-ppn');
                        if (includePPNCheckbox) {
                            includePPNCheckbox.checked = dataToFill.includePPN || false;
                        }
                        break;
                    case 'keterangan-modal':
                        document.getElementById('keterangan-tgl-pengajuan-finance').value = dataToFill.tglPengajuanFinance || '';
                        document.getElementById('keterangan-tgl-pengajuan-reni').value = dataToFill.tglPengajuanReni || '';
                        document.getElementById('keterangan-tgl-diterima-anggi').value = dataToFill.tglDiterimaAnggi || '';
                        document.getElementById('keterangan-keterangan-proses').value = dataToFill.keteranganProses || '';
                        document.getElementById('keterangan-tgl-bayar').value = dataToFill.tglBayar || '';
                        document.getElementById('keterangan-status-akhir').value = dataToFill.statusAkhir || '';
                        calculateLamaPengajuan();
                        break;
                    case 'status-modal':
                        document.getElementById('status-no-invoice').value = rawInvoiceNo;
                        document.getElementById('status-manual-select').value = dataToFill.statusAkhir || '';
                        break;
                }
            }

            // --- Form Submissions (Firestore) ---
            document.getElementById('faktur-pajak-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const rawNoInvoice = document.getElementById('fp-no-invoice').value;
                const formData = {
                    noInvoice: rawNoInvoice,
                    tglFakturPajak: document.getElementById('fp-tgl-faktur-pajak').value,
                    noFakturPajak: document.getElementById('fp-no-faktur-pajak').value,
                };

                try {
                    const existingDocQuery = await fakturPajakCol.where('noInvoice', '==', rawNoInvoice).limit(1).get();
                    if (!existingDocQuery.empty) {
                        await fakturPajakCol.doc(existingDocQuery.docs[0].id).update(formData);
                    } else {
                        await fakturPajakCol.add(formData);
                    }
                    showAlert('Faktur Pajak berhasil disimpan!', 'success');
                    closeModal('faktur-pajak-modal');
                    if (document.getElementById('invoice-detail-section').style.display === 'block') {
                        displayInvoiceDetail(rawNoInvoice);
                    }
                } catch (error) {
                    console.error("Error saving Faktur Pajak: ", error);
                    showAlert("Gagal menyimpan Faktur Pajak: " + error.message, 'error');
                }
            });

            // --- Pembayaran Form Submission dengan PPN ---
            document.getElementById('pembayaran-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const rawNoInvoice = document.getElementById('pembayaran-no-invoice').value;
                const dppIdrRaw = document.getElementById('pembayaran-dpp-idr').value.replace(/[^0-9]/g, '');
                const ppnIdrRaw = document.getElementById('pembayaran-ppn-idr').value.replace(/[^0-9]/g, '');
                const includePPN = document.getElementById('pembayaran-include-ppn').checked;

                const formData = {
                    noInvoice: rawNoInvoice,
                    dppIdr: dppIdrRaw,
                    ppnIdr: ppnIdrRaw,
                    dppUsd: document.getElementById('pembayaran-dpp-usd').value,
                    keterangan: document.getElementById('pembayaran-keterangan').value,
                    followUp: document.getElementById('pembayaran-follow-up').value,
                    hasilFollowUp: document.getElementById('pembayaran-hasil-follow-up').value,
                    top: document.getElementById('pembayaran-top').value,
                    jatuhTempo: document.getElementById('pembayaran-jatuh-tempo').value,
                    includePPN: includePPN
                };

                try {
                    const existingDocQuery = await pembayaranCol.where('noInvoice', '==', rawNoInvoice).limit(1).get();
                    if (!existingDocQuery.empty) {
                        await pembayaranCol.doc(existingDocQuery.docs[0].id).update(formData);
                    } else {
                        await pembayaranCol.add(formData);
                    }
                    showAlert('Pembayaran berhasil disimpan!', 'success');
                    closeModal('pembayaran-modal');
                    if (document.getElementById('invoice-detail-section').style.display === 'block') {
                        displayInvoiceDetail(rawNoInvoice);
                    }
                } catch (error) {
                    console.error("Error saving Pembayaran: ", error);
                    showAlert("Gagal menyimpan Pembayaran: " + error.message, 'error');
                }
            });

            // --- Keterangan Form Submission ---
            document.getElementById('keterangan-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const rawNoInvoice = document.getElementById('keterangan-no-invoice').value;

                const invoiceNoDocId = sanitizeInvoiceNo(rawNoInvoice);
                const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                const invoiceData = invoiceDoc.exists ? invoiceDoc.data() : {};

                const pembayaranQuery = await pembayaranCol.where('noInvoice', '==', rawNoInvoice).limit(1).get();
                const pembayaranData = pembayaranQuery.empty ? {} : pembayaranQuery.docs[0].data();

                const newTglBayar = document.getElementById('keterangan-tgl-bayar').value;
                const selectedManualStatus = document.getElementById('keterangan-status-akhir').value;

                // Jika pengguna memilih status dari dropdown, itu dianggap manual
                const isManual = selectedManualStatus !== '';

                const newStatusAkhir = calculateStatus(
                    invoiceData.tglDiterima,
                    pembayaranData.jatuhTempo,
                    newTglBayar,
                    selectedManualStatus,
                    isManual
                );

                const formData = {
                    noInvoice: rawNoInvoice,
                    tglPengajuanFinance: document.getElementById('keterangan-tgl-pengajuan-finance').value,
                    tglPengajuanReni: document.getElementById('keterangan-tgl-pengajuan-reni').value,
                    tglDiterimaAnggi: document.getElementById('keterangan-tgl-diterima-anggi').value,
                    lamaPengajuan: document.getElementById('keterangan-lama-pengajuan').value,
                    keteranganProses: document.getElementById('keterangan-keterangan-proses').value,
                    tglBayar: newTglBayar,
                    statusAkhir: newStatusAkhir,
                    isManualStatus: isManual
                };

                try {
                    const existingDocQuery = await keteranganCol.where('noInvoice', '==', rawNoInvoice).limit(1).get();
                    if (!existingDocQuery.empty) {
                        await keteranganCol.doc(existingDocQuery.docs[0].id).update(formData);
                    } else {
                        await keteranganCol.add(formData);
                    }
                    showAlert('Keterangan & Status berhasil disimpan!', 'success');
                    closeModal('keterangan-modal');
                    if (document.getElementById('invoice-detail-section').style.display === 'block') {
                        displayInvoiceDetail(rawNoInvoice);
                    }
                } catch (error) {
                    console.error("Error saving Keterangan: ", error);
                    showAlert("Gagal menyimpan Keterangan: " + error.message, 'error');
                }
            });

            // --- Calculate Lama Pengajuan ---
            const tglPengajuanFinanceInput = document.getElementById('keterangan-tgl-pengajuan-finance');
            const tglDiterimaAnggiInput = document.getElementById('keterangan-tgl-diterima-anggi');
            const lamaPengajuanInput = document.getElementById('keterangan-lama-pengajuan');

            function calculateLamaPengajuan() {
                if (!tglPengajuanFinanceInput || !tglDiterimaAnggiInput || !lamaPengajuanInput) return;

                const tglFinance = tglPengajuanFinanceInput.value;
                const tglAnggi = tglDiterimaAnggiInput.value;

                if (tglFinance && tglAnggi) {
                    const date1 = new Date(tglFinance);
                    const date2 = new Date(tglAnggi);
                    const diffTime = Math.abs(date2 - date1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    lamaPengajuanInput.value = `${diffDays} Hari`;
                } else {
                    lamaPengajuanInput.value = '';
                }
            }

            if (tglPengajuanFinanceInput) tglPengajuanFinanceInput.addEventListener('change', calculateLamaPengajuan);
            if (tglDiterimaAnggiInput) tglDiterimaAnggiInput.addEventListener('change', calculateLamaPengajuan);

            // --- Auto-calculate Jatuh Tempo based on TOP ---
            const pembayaranTopInput = document.getElementById('pembayaran-top');
            const pembayaranJatuhTempoInput = document.getElementById('pembayaran-jatuh-tempo');
            const tempInvoiceTglDiterimaInput = document.getElementById('invoice-tgl-diterima');

            async function calculateJatuhTempo() {
                const topValue = parseInt(pembayaranTopInput.value, 10);
                const rawNoInvoice = document.getElementById('pembayaran-no-invoice').value;

                if (isNaN(topValue) || topValue <= 0 || !rawNoInvoice) {
                    pembayaranJatuhTempoInput.value = '';
                    return;
                }

                let tglDiterimaInvoice = '';

                if (tempInvoiceTglDiterimaInput && tempInvoiceTglDiterimaInput.value) {
                    tglDiterimaInvoice = tempInvoiceTglDiterimaInput.value;
                } else {
                    try {
                        const invoiceNoDocId = sanitizeInvoiceNo(rawNoInvoice);
                        const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                        if (invoiceDoc.exists) {
                            tglDiterimaInvoice = invoiceDoc.data().tglDiterima || '';
                        }
                    } catch (error) {
                        console.error("Error fetching tglDiterima for Jatuh Tempo calculation:", error);
                        showAlert("Gagal mengambil Tanggal Diterima untuk perhitungan Jatuh Tempo.", 'error');
                        pembayaranJatuhTempoInput.value = '';
                        return;
                    }
                }

                if (tglDiterimaInvoice) {
                    const receivedDate = new Date(tglDiterimaInvoice);
                    receivedDate.setDate(receivedDate.getDate() + topValue);

                    const year = receivedDate.getFullYear();
                    const month = String(receivedDate.getMonth() + 1).padStart(2, '0');
                    const day = String(receivedDate.getDate()).padStart(2, '0');
                    pembayaranJatuhTempoInput.value = `${year}-${month}-${day}`;
                } else {
                    pembayaranJatuhTempoInput.value = '';
                }
            }

            if (pembayaranTopInput) {
                pembayaranTopInput.addEventListener('change', calculateJatuhTempo);
            }

            // --- Event Listeners for PPN Calculation ---
            const includePPNCheckbox = document.getElementById('pembayaran-include-ppn');
            const dppIdrInput = document.getElementById('pembayaran-dpp-idr');
            const ppnIdrInput = document.getElementById('pembayaran-ppn-idr');

            if (includePPNCheckbox && dppIdrInput) {
                includePPNCheckbox.addEventListener('change', calculatePPN);
                dppIdrInput.addEventListener('input', calculatePPN);
                dppIdrInput.addEventListener('blur', calculatePPN);
                
                // Hapus readonly dari input PPN agar bisa diisi manual
                if (ppnIdrInput) {
                    ppnIdrInput.readOnly = false;
                }
            }

            // --- Export to Excel (CSV) ---
            document.querySelectorAll('.header-actions .export-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (allInvoiceData.length === 0) {
                        showAlert('Tidak ada data untuk diekspor.', 'info');
                        return;
                    }

                    const headers = Object.keys(allInvoiceData[0]);
                    let csv = headers.join(',') + '\n';

                    allInvoiceData.forEach(row => {
                        const values = headers.map(header => {
                            const value = row[header];
                            return `"${String(value).replace(/"/g, '""')}"`;
                        });
                        csv += values.join(',') + '\n';
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', 'finance_data.csv');
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showAlert('Data berhasil diekspor ke CSV.', 'success');
                    }
                });
            });

            // --- Filter Event Listeners ---
            document.getElementById('filter-start-date').addEventListener('change', applyFilters);
            document.getElementById('filter-end-date').addEventListener('change', applyFilters);
            document.getElementById('filter-status').addEventListener('change', applyFilters);
            document.getElementById('filter-search').addEventListener('keyup', applyFilters);

            const applyFilterBtn = document.querySelector('#invoice-list-section .btn-primary');
            if (applyFilterBtn) {
                applyFilterBtn.addEventListener('click', function() {
                    applyFilters();
                });
            }

            // Setup Rupiah formatting for relevant inputs
            setupRupiahInput('pembayaran-dpp-idr');
            setupRupiahInput('pembayaran-ppn-idr');

            // --- Status Modal Specifics ---
            const statusModal = document.getElementById('status-modal');
            const statusNoInvoiceInput = document.getElementById('status-no-invoice');
            const statusManualSelect = document.getElementById('status-manual-select');
            const statusForm = document.getElementById('status-form');

            async function openStatusModal(rawInvoiceNo, currentStatus) {
                statusNoInvoiceInput.value = rawInvoiceNo;
                statusNoInvoiceInput.readOnly = true;
                statusManualSelect.value = currentStatus || '';
                statusModal.style.display = 'flex';
            }

            statusForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const rawNoInvoice = statusNoInvoiceInput.value;
                const newManualStatus = statusManualSelect.value;

                try {
                    const keteranganQuery = await keteranganCol.where('noInvoice', '==', rawNoInvoice).limit(1).get();
                    let keteranganDocRef;
                    let existingKeteranganData = {};

                    if (!keteranganQuery.empty) {
                        keteranganDocRef = keteranganQuery.docs[0].ref;
                        existingKeteranganData = keteranganQuery.docs[0].data();
                    } else {
                        // If no existing keterangan, create a new one with manual status
                        await keteranganCol.add({
                            noInvoice: rawNoInvoice,
                            statusAkhir: newManualStatus,
                            isManualStatus: true
                        });
                        showAlert('Keterangan baru dibuat dan status diperbarui!', 'success');
                        closeModal('status-modal');
                        return;
                    }

                    const invoiceNoDocId = sanitizeInvoiceNo(rawNoInvoice);
                    const invoiceDoc = await invoicesCol.doc(invoiceNoDocId).get();
                    const invoiceData = invoiceDoc.exists ? invoiceDoc.data() : {};

                    const pembayaranQuery = await pembayaranCol.where('noInvoice', '==', rawNoInvoice).limit(1).get();
                    const pembayaranData = pembayaranQuery.empty ? {} : pembayaranQuery.docs[0].data();

                    const finalStatus = calculateStatus(
                        invoiceData.tglDiterima,
                        pembayaranData.jatuhTempo,
                        existingKeteranganData.tglBayar,
                        newManualStatus,
                        true
                    );

                    const updateData = {
                        ...existingKeteranganData,
                        statusAkhir: finalStatus,
                        isManualStatus: true
                    };

                    await keteranganDocRef.update(updateData);

                    showAlert('Status invoice berhasil diperbarui!', 'success');
                    closeModal('status-modal');
                } catch (error) {
                    console.error("Error updating invoice status: ", error);
                    showAlert("Gagal memperbarui status invoice: " + error.message, 'error');
                }
            });

            // --- Status Summary Click Handlers ---
            document.getElementById('dashboard-total-invoice').parentElement.addEventListener('click', function() {
                openStatusSummaryModal('total');
            });
            
            document.getElementById('dashboard-paid-invoice').parentElement.addEventListener('click', function() {
                openStatusSummaryModal('paid');
            });
            
            document.getElementById('dashboard-pending-invoice').parentElement.addEventListener('click', function() {
                openStatusSummaryModal('pending');
            });
            
            document.getElementById('dashboard-submission-pending-invoice').parentElement.addEventListener('click', function() {
                openStatusSummaryModal('submission-pending');
            });
            
            document.getElementById('dashboard-overdue-invoice').parentElement.addEventListener('click', function() {
                openStatusSummaryModal('overdue');
            });

            // Status Summary Modal Close Button
            document.getElementById('status-summary-close-btn').addEventListener('click', function() {
                closeStatusSummaryModal();
            });

            // Load vendor data
            loadVendorData();
        });
    </script>

    <!-- Improved Login Screen -->
    <div id="auth-container" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-chart-line auth-logo-icon"></i>
                <span class="auth-logo-text">FinanceMonitor</span>
            </div>
            <h2>Login to Your Account</h2>
            <form id="login-form" class="auth-form">
                <div class="auth-input-group">
                    <i class="fas fa-envelope auth-input-icon"></i>
                    <input type="email" id="email" class="auth-input" placeholder="Email Address" required>
                </div>
                <div class="auth-input-group">
                    <i class="fas fa-lock auth-input-icon"></i>
                    <input type="password" id="password" class="auth-input" placeholder="Password" required>
                </div>
                <div id="login-error" class="auth-error-message"></div>
                <button type="submit" id="login-btn" class="auth-submit-btn">Login</button>
            </form>
            <div class="auth-footer">
                <p>Secure Finance Monitoring System</p>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until login) -->
    <div id="main-container" class="container" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <button id="sidebar-toggle-btn" class="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
                <div class="logo-text">FinanceMonitor</div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-target="dashboard-section">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Dashboard</div>
                </a>
                <a href="#" class="nav-item" data-target="invoice-list-section">
                    <div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="nav-text">Invoice</div>
                </a>
                <a href="#" class="nav-item" data-target="faktur-pajak-section">
                    <div class="nav-icon"><i class="fas fa-receipt"></i></div>
                    <div class="nav-text">Faktur Pajak</div>
                </a>
                <a href="#" class="nav-item" data-target="pembayaran-section">
                    <div class="nav-icon"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="nav-text">Pembayaran</div>
                </a>
                <a href="#" class="nav-item" data-target="keterangan-section">
                    <div class="nav-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="nav-text">Keterangan</div>
                </a>
                <a href="#" class="nav-item" data-target="pengaturan-section">
                    <div class="nav-icon"><i class="fas fa-cog"></i></div>
                    <div class="nav-text">Pengaturan Akun</div>
                </a>
                <a href="#" class="nav-item" id="logout-btn">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h3>Ringkasan Status Invoice</h3>
                        <div class="dashboard-summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-total-invoice">0</div>
                                <div class="summary-label">Total Invoice</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-paid-invoice">0</div>
                                <div class="summary-label">Telah Dibayar</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-pending-invoice">0</div>
                                <div class="summary-label">Menunggu Pembayaran</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-submission-pending-invoice">0</div>
                                <div class="summary-label">Menunggu Pengajuan</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-overdue-invoice">0</div>
                                <div class="summary-label">Jatuh Tempo</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Invoice List Section -->
            <section id="invoice-list-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Daftar Invoice</h1>
                    <div class="header-actions">
                        <button class="btn btn-outline export-btn">
                            <i class="fas fa-download btn-icon"></i> Export
                        </button>
                        <button class="btn btn-primary" id="add-invoice-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Invoice
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Filter Data</h2>
                    </div>
                    <div class="card-body">
                        <div class="filter-section">
                            <div class="filter-group">
                                <label class="filter-label">Tanggal Mulai</label>
                                <input type="date" class="filter-input" id="filter-start-date">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Tanggal Akhir</label>
                                <input type="date" class="filter-input" id="filter-end-date">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Status</label>
                                <select class="filter-input" id="filter-status">
                                    <option value="">Semua Status</option>
                                    <option value="Menunggu Pengajuan">Menunggu Pengajuan</option>
                                    <option value="Diajukan ke Finance">Diajukan ke Finance</option>
                                    <option value="Diterima Anggi">Diterima Anggi</option>
                                    <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                                    <option value="Dibayar">Dibayar</option>
                                    <option value="Jatuh Tempo">Jatuh Tempo</option>
                                    <option value="Dibatalkan">Dibatalkan</option>
                                    <option value="Belum Diproses">Belum Diproses</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Cari</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="filter-input" id="filter-search" placeholder="Cari invoice, vendor...">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary">
                            <i class="fas fa-filter btn-icon"></i> Terapkan Filter
                        </button>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Daftar Invoice</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="invoice-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Email/Hard</th>
                                        <th>Penerima</th>
                                        <th>Corp</th>
                                        <th>Tanggal Diterima</th>
                                        <th>No Invoice</th>
                                        <th>Nama Vendor</th>
                                        <th>DPP & PPN</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                            <div class="page-info">
                                Menampilkan 0-0 dari 0 data
                            </div>
                            <div class="page-controls">
                                <!-- Pagination buttons will be rendered here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Invoice Detail Section (Hidden by default) -->
            <section id="invoice-detail-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Detail Invoice: <span id="detail-invoice-no"></span></h1>
                    <div class="header-actions">
                        <button class="btn btn-outline" id="back-to-list-btn">
                            <i class="fas fa-arrow-left btn-icon"></i> Kembali ke Daftar
                        </button>
                        <button class="btn btn-outline" id="export-detail-btn">
                            <i class="fas fa-download btn-icon"></i> Export Detail
                        </button>
                        <button class="btn btn-primary" id="edit-full-invoice-btn">
                            <i class="fas fa-edit btn-icon"></i> Edit Invoice
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="detail-section">
                            <h3>Informasi Dasar Invoice</h3>
                            <div class="detail-item"><strong>Email/Hard:</strong> <span id="detail-email-hard"></span></div>
                            <div class="detail-item"><strong>Penerima:</strong> <span id="detail-penerima"></span></div>
                            <div class="detail-item"><strong>Corp:</strong> <span id="detail-corp"></span></div>
                            <div class="detail-item"><strong>Tanggal Diterima:</strong> <span id="detail-tgl-diterima"></span></div>
                            <div class="detail-item"><strong>Tanggal Invoice:</strong> <span id="detail-tgl-invoice"></span></div>
                            <div class="detail-item"><strong>Surat Jalan/BA:</strong> <span id="detail-surat-jalan"></span></div>
                            <div class="detail-item"><strong>Nama Vendor:</strong> <span id="detail-nama-vendor"></span></div>
                        </div>

                        <div class="detail-section">
                            <h3>Detail Faktur Pajak</h3>
                            <div class="detail-item"><strong>No Faktur Pajak:</strong> <span id="detail-no-faktur-pajak"></span></div>
                            <div class="detail-item"><strong>Tanggal Faktur Pajak:</strong> <span id="detail-tgl-faktur-pajak"></span></div>
                            <div class="detail-item">
                                <button class="btn btn-outline btn-sm" id="add-edit-faktur-pajak-btn">
                                    <i class="fas fa-plus btn-icon"></i> Tambah/Edit Faktur Pajak
                                </button>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Detail Pembayaran</h3>
                            <div class="detail-item"><strong>DPP (IDR):</strong> <span id="detail-dpp-idr"></span></div>
                            <div class="detail-item"><strong>PPn (IDR):</strong> <span id="detail-ppn-idr"></span></div>
                            <div class="detail-item"><strong>DPP (USD):</strong> <span id="detail-dpp-usd"></span></div>
                            <div class="detail-item"><strong>Keterangan Pembayaran:</strong> <span id="detail-keterangan-pembayaran"></span></div>
                            <div class="detail-item"><strong>Follow Up:</strong> <span id="detail-follow-up"></span></div>
                            <div class="detail-item"><strong>Hasil Follow Up:</strong> <span id="detail-hasil-follow-up"></span></div>
                            <div class="detail-item"><strong>TOP:</strong> <span id="detail-top"></span></div>
                            <div class="detail-item"><strong>Jatuh Tempo:</strong> <span id="detail-jatuh-tempo"></span></div>
                            <div class="detail-item">
                                <button class="btn btn-outline btn-sm" id="add-edit-pembayaran-btn">
                                    <i class="fas fa-plus btn-icon"></i> Tambah/Edit Pembayaran
                                </button>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Status & Proses Internal</h3>
                            <div class="detail-item"><strong>Tanggal Pengajuan ke Finance:</strong> <span id="detail-tgl-pengajuan-finance"></span></div>
                            <div class="detail-item"><strong>Tanggal Pengajuan (Reni):</strong> <span id="detail-tgl-pengajuan-reni"></span></div>
                            <div class="detail-item"><strong>Tanggal Diterima (Anggi):</strong> <span id="detail-tgl-diterima-anggi"></span></div>
                            <div class="detail-item"><strong>Lama Pengajuan:</strong> <span id="detail-lama-pengajuan"></span></div>
                            <div class="detail-item"><strong>Keterangan Proses:</strong> <span id="detail-keterangan-proses"></span></div>
                            <div class="detail-item"><strong>Tanggal Bayar:</strong> <span id="detail-tgl-bayar"></span></div>
                            <div class="detail-item"><strong>Status Akhir:</strong> <span id="detail-status-akhir"></span></div>
                            <div class="detail-item">
                                <button class="btn btn-outline btn-sm" id="add-edit-keterangan-btn">
                                    <i class="fas fa-plus btn-icon"></i> Tambah/Edit Keterangan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Faktur Pajak Section (Standalone for direct access from sidebar) -->
            <section id="faktur-pajak-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Manajemen Faktur Pajak</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-faktur-pajak-standalone-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Faktur Pajak
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>Gunakan form di bawah untuk mencari No Invoice dan menambahkan/mengedit Faktur Pajak terkait.</p>
                        <div class="filter-group" style="max-width: 400px; margin-bottom: 1rem;">
                            <label class="filter-label">Cari No Invoice untuk Faktur Pajak</label>
                            <div class="autocomplete-container">
                                <input type="text" class="filter-input" id="search-invoice-faktur-pajak" placeholder="Masukkan No Invoice...">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="search-faktur-pajak-btn">Cari & Tambah/Edit</button>
                    </div>
                </div>
            </section>

            <!-- Pembayaran Section (Standalone for direct access from sidebar) -->
            <section id="pembayaran-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Manajemen Pembayaran</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-pembayaran-standalone-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Pembayaran
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>Gunakan form di bawah untuk mencari No Invoice dan menambahkan/mengedit Pembayaran terkait.</p>
                        <div class="filter-group" style="max-width: 400px; margin-bottom: 1rem;">
                            <label class="filter-label">Cari No Invoice untuk Pembayaran</label>
                            <div class="autocomplete-container">
                                <input type="text" class="filter-input" id="search-invoice-pembayaran" placeholder="Masukkan No Invoice...">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="search-pembayaran-btn">Cari & Tambah/Edit</button>
                    </div>
                </div>
            </section>

            <!-- Keterangan Section (Standalone for direct access from sidebar) -->
            <section id="keterangan-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Manajemen Keterangan & Status</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-keterangan-standalone-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Keterangan
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>Gunakan form di bawah untuk mencari No Invoice dan menambahkan/mengedit Keterangan & Status terkait.</p>
                        <div class="filter-group" style="max-width: 400px; margin-bottom: 1rem;">
                            <label class="filter-label">Cari No Invoice untuk Keterangan</label>
                            <div class="autocomplete-container">
                                <input type="text" class="filter-input" id="search-invoice-keterangan" placeholder="Masukkan No Invoice...">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="search-keterangan-btn">Cari & Tambah/Edit</button>
                    </div>
                </div>
            </section>

            <!-- Pengaturan Section -->
            <section id="pengaturan-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Pengaturan Akun</h1>
                </div>
                <div class="settings-layout">
                    <div class="card settings-card">
                        <div class="card-body">
                            <form id="settings-form">
                                <div class="form-group">
                                    <label for="settings-email">Email</label>
                                    <input type="email" id="settings-email" class="filter-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-password">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                                    <input type="password" id="settings-password" class="filter-input" placeholder="Minimal 6 karakter">
                                </div>
                                <div class="form-group">
                                    <label for="settings-confirm-password">Konfirmasi Password Baru</label>
                                    <input type="password" id="settings-confirm-password" class="filter-input">
                                </div>
                                <div class="form-group">
                                    <a href="#" id="forgot-password-link" style="color: var(--primary); text-decoration: underline; font-size: 0.9rem;">Lupa Password?</a>
                                </div>
                                <p class="error-message" id="forgot-password-error-message" style="display: none;"></p>
                                <p class="status-paid" id="forgot-password-success-message" style="display: none; padding: 0.5rem; border-radius: 0.5rem;"></p>
                                <p class="error-message" id="settings-error-message" style="display: none;"></p>
                                <p class="status-paid" id="settings-success-message" style="display: none; padding: 0.5rem; border-radius: 0.5rem;"></p>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- MODALS -->
    <!-- Modal Tambah/Edit Invoice -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Invoice</h2>
            <form id="invoice-form">
                <div class="form-group">
                    <label for="invoice-email-hard">Email/Hard</label>
                    <select id="invoice-email-hard" class="filter-input" required>
                        <option value="">Pilih</option>
                        <option value="Email">Email</option>
                        <option value="Hard">Hardcopy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="invoice-penerima">Penerima</label>
                    <input type="text" id="invoice-penerima" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-corp">Corp</label>
                    <input type="text" id="invoice-corp" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-tgl-diterima">Tanggal Diterima</label>
                    <input type="date" id="invoice-tgl-diterima" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-tgl-invoice">Tanggal Invoice</label>
                    <input type="date" id="invoice-tgl-invoice" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-surat-jalan">Surat Jalan/BA</label>
                    <input type="text" id="invoice-surat-jalan" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="invoice-nama-vendor">Nama Vendor</label>
                    <div class="autocomplete-container">
                        <input type="text" id="invoice-nama-vendor" class="filter-input" required placeholder="Ketik untuk mencari vendor...">
                    </div>
                </div>
                <div class="form-group">
                    <label for="invoice-no-invoice">No Invoice</label>
                    <input type="text" id="invoice-no-invoice" class="filter-input" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Faktur Pajak -->
    <div id="faktur-pajak-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Faktur Pajak</h2>
            <form id="faktur-pajak-form">
                <div class="form-group">
                    <label for="fp-no-invoice">No Invoice</label>
                    <input type="text" id="fp-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="fp-tgl-faktur-pajak">Tanggal Faktur Pajak</label>
                    <input type="date" id="fp-tgl-faktur-pajak" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="fp-no-faktur-pajak">No Faktur Pajak</label>
                    <input type="text" id="fp-no-faktur-pajak" class="filter-input" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Faktur Pajak</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Pembayaran -->
    <div id="pembayaran-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Pembayaran</h2>
            <form id="pembayaran-form">
                <div class="form-group">
                    <label for="pembayaran-no-invoice">No Invoice</label>
                    <input type="text" id="pembayaran-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="pembayaran-dpp-idr">DPP (IDR)</label>
                    <input type="text" id="pembayaran-dpp-idr" class="filter-input rupiah-input" placeholder="Rp 0">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pembayaran-include-ppn">
                    <label for="pembayaran-include-ppn">Harga sudah termasuk PPN 11%</label>
                </div>
                <div class="form-group">
                    <label for="pembayaran-ppn-idr">PPn (IDR)</label>
                    <input type="text" id="pembayaran-ppn-idr" class="filter-input rupiah-input" placeholder="Rp 0">
                </div>
                <div class="form-group">
                    <label for="pembayaran-dpp-usd">DPP (USD)</label>
                    <input type="text" id="pembayaran-dpp-usd" class="filter-input" placeholder="$ 0.00">
                </div>
                <div class="form-group">
                    <label for="pembayaran-keterangan">Keterangan</label>
                    <textarea id="pembayaran-keterangan" class="filter-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="pembayaran-follow-up">Follow Up</label>
                    <select id="pembayaran-follow-up" class="filter-input">
                        <option value="Tidak">Tidak</option>
                        <option value="Ya">Ya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pembayaran-hasil-follow-up">Hasil Follow Up</label>
                    <textarea id="pembayaran-hasil-follow-up" class="filter-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="pembayaran-top">TOP (Term of Payment)</label>
                    <input type="number" id="pembayaran-top" class="filter-input" placeholder="Contoh: 30">
                </div>
                <div class="form-group">
                    <label for="pembayaran-jatuh-tempo">Jatuh Tempo</label>
                    <input type="date" id="pembayaran-jatuh-tempo" class="filter-input">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Pembayaran</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Keterangan -->
    <div id="keterangan-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Keterangan & Status</h2>
            <form id="keterangan-form">
                <div class="form-group">
                    <label for="keterangan-no-invoice">No Invoice</label>
                    <input type="text" id="keterangan-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-pengajuan-finance">Tanggal Pengajuan ke Finance</label>
                    <input type="date" id="keterangan-tgl-pengajuan-finance" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-pengajuan-reni">Tanggal Pengajuan (Reni)</label>
                    <input type="date" id="keterangan-tgl-pengajuan-reni" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-diterima-anggi">Tanggal Diterima (Anggi)</label>
                    <input type="date" id="keterangan-tgl-diterima-anggi" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-lama-pengajuan">Lama Pengajuan (Hari)</label>
                    <input type="text" id="keterangan-lama-pengajuan" class="filter-input" readonly placeholder="Otomatis dihitung">
                </div>
                <div class="form-group">
                    <label for="keterangan-keterangan-proses">Keterangan Proses</label>
                    <textarea id="keterangan-keterangan-proses" class="filter-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-bayar">Tanggal Bayar</label>
                    <input type="date" id="keterangan-tgl-bayar" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-status-akhir">Status Akhir</label>
                    <select id="keterangan-status-akhir" class="filter-input">
                        <option value="">Pilih Status</option>
                        <option value="Menunggu Pengajuan">Menunggu Pengajuan</option>
                        <option value="Diajukan ke Finance">Diajukan ke Finance</option>
                        <option value="Diterima Anggi">Diterima Anggi</option>
                        <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                        <option value="Dibayar">Dibayar</option>
                        <option value="Jatuh Tempo">Jatuh Tempo</option>
                        <option value="Dibatalkan">Dibatalkan</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Keterangan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW Modal for Manual Status Update -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Ubah Status Invoice Manual</h2>
            <form id="status-form">
                <div class="form-group">
                    <label for="status-no-invoice">No Invoice</label>
                    <input type="text" id="status-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="status-manual-select">Pilih Status Manual</label>
                    <select id="status-manual-select" class="filter-input" required>
                        <option value="">Pilih Status</option>
                        <option value="Menunggu Pengajuan">Menunggu Pengajuan</option>
                        <option value="Diajukan ke Finance">Diajukan ke Finance</option>
                        <option value="Diterima Anggi">Diterima Anggi</option>
                        <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                        <option value="Dibayar">Dibayar</option>
                        <option value="Jatuh Tempo">Jatuh Tempo</option>
                        <option value="Dibatalkan">Dibatalkan</option>
                        <option value="Belum Diproses">Belum Diproses</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW Modal for Status Summary -->
    <div id="status-summary-modal" class="status-summary-modal">
        <div class="status-summary-content">
            <div class="status-summary-header">
                <h2 class="status-summary-title" id="status-summary-title">Daftar Invoice</h2>
                <button class="status-summary-close-btn" id="status-summary-close-btn">&times;</button>
            </div>
            <div class="status-summary-table-container">
                <table id="status-summary-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>No Invoice</th>
                            <th>Nama Vendor</th>
                            <th>DPP</th>
                            <th>Status</th>
                            <th>Keterangan Proses</th>
                            <th>Jatuh Tempo</th>
                            <th>Tanggal Bayar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Custom Alert Box -->
    <div id="custom-alert-box" class="custom-alert"></div>
</body>
</html>

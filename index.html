<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Monitoring System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ALL THE ORIGINAL STYLES REMAIN UNCHANGED */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #94a3b8;
            --border: #e2e8f0;
            --bg: #ffffff;
            --card-bg: #ffffff;
            --sidebar-bg: #f1f5f9;
            --hover: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #334155;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ========== IMPROVED LOGIN STYLES ========== */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
        }

        .auth-card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }

        .auth-card h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--dark);
            font-weight: 700;
            font-size: 1.75rem;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .auth-logo-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-right: 0.75rem;
        }

        .auth-logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--dark);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .auth-input-group {
            position: relative;
        }

        .auth-input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 2.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            font-size: 1rem;
        }

        .auth-submit-btn {
            padding: 0.9rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background-color: var(--primary);
            color: white;
            font-size: 1rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .auth-submit-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
        }

        .auth-submit-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .auth-submit-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .auth-error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
            border-left: 4px solid var(--danger);
            text-align: center;
        }

        .auth-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== EXISTING STYLES (FULL SCREEN) ========== */
        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }

        .logo-icon {
            font-size: 1.8rem;
            color: var(--primary);
            margin-right: 0.75rem;
        }

        .sidebar.collapsed .logo-icon {
            margin-right: 0;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--dark);
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: var(--secondary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background-color: var(--hover);
            color: var(--primary);
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .sidebar.collapsed .nav-icon {
            margin-right: 0;
        }

        .nav-text {
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: absolute;
            top: 1.5rem;
            right: -12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: right 0.3s ease, transform 0.3s ease;
            z-index: 10;
        }

        .sidebar.collapsed .sidebar-toggle {
            right: -12px;
            transform: rotate(180deg);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
            background-color: #f1f5f9;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background-color: var(--hover);
        }

        .btn-icon {
            margin-right: 0.5rem;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        .filter-input {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            width: 100%;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        th, td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            word-wrap: break-word;
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--dark);
        }

        td {
            color: var(--secondary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .status-button {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
        }

        .status-button:hover {
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-paid {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-diajukan-finance {
            background-color: #bfdbfe;
            color: #1e40af;
        }

        .status-diterima-anggi {
            background-color: #dbeafe;
            color: #1e3a8a;
        }

        .status-dibatalkan {
            background-color: #fecaca;
            color: #b91c1c;
        }

        .status-belum-diproses, .status-menunggu-pengajuan {
            background-color: #e2e8f0;
            color: #475569;
        }

        .action-cell {
            display: flex;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .action-btn {
            padding: 0.4rem 0.6rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--secondary);
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background-color: var(--hover);
            color: var(--primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem 0;
        }

        .page-info {
            font-size: 0.875rem;
            color: var(--secondary);
        }

        .page-controls {
            display: flex;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover {
            background-color: var(--hover);
        }

        .page-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close-btn {
            color: var(--secondary);
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: var(--dark);
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            width: 100%;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background-color: var(--light);
        }

        .detail-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .detail-item {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .detail-item strong {
            width: 180px;
            flex-shrink: 0;
            color: var(--dark);
        }

        .detail-item span {
            flex-grow: 1;
            color: var(--secondary);
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border);
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-items div:hover {
            background-color: var(--hover);
        }

        .autocomplete-active {
            background-color: var(--primary) !important;
            color: #ffffff;
        }

        /* Custom Alert/Notification Styles */
        .custom-alert {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            color: white;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-alert.show {
            opacity: 1;
        }

        .custom-alert.success {
            background-color: var(--success);
        }

        .custom-alert.error {
            background-color: var(--danger);
        }

        .custom-alert.info {
            background-color: var(--primary);
        }

        /* Dashboard Summary Grid */
        .dashboard-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .summary-item {
            background-color: var(--light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease;
        }

        .summary-item:hover {
            transform: translateY(-3px);
        }

        .summary-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--secondary);
        }

        /* Specific colors for summary items */
        .summary-item:nth-child(1) .summary-value { color: var(--dark); }
        .summary-item:nth-child(2) .summary-value { color: var(--success); }
        .summary-item:nth-child(3) .summary-value { color: var(--warning); }
        .summary-item:nth-child(4) .summary-value { color: var(--primary); }
        .summary-item:nth-child(5) .summary-value { color: var(--danger); }

        /* Settings Layout */
        .settings-layout {
            display: flex;
            justify-content: center;
            padding-top: 1rem;
        }

        .settings-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--dark);
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 1rem;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                gap: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            .nav-item {
                margin-bottom: 0;
                white-space: nowrap;
            }

            .sidebar-toggle {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .pagination {
                flex-direction: column;
                gap: 1rem;
            }

            .detail-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .detail-item strong {
                width: auto;
                margin-bottom: 0.25rem;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            .page-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-wZ0y0jG-MstU1MPIQQg8pyLnefx8ADQ",
            authDomain: "monitoring-finance.firebaseapp.com",
            projectId: "monitoring-finance",
            storageBucket: "monitoring-finance.firebasestorage.app",
            messagingSenderId: "312581732577",
            appId: "1:312581732577:web:0ee71d80770eea1ed39fa0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firestore Collections references
        const invoicesCol = db.collection('invoices');
        const fakturPajakCol = db.collection('fakturPajak');
        const pembayaranCol = db.collection('pembayaran');
        const keteranganCol = db.collection('keterangan');

        // --- Custom Alert Function ---
        function showAlert(message, type = 'info', duration = 3000) {
            let alertBox = document.getElementById('custom-alert-box');
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'custom-alert-box';
                alertBox.className = 'custom-alert';
                document.body.appendChild(alertBox);
            }

            alertBox.textContent = message;
            alertBox.className = `custom-alert ${type}`;
            alertBox.style.display = 'block';

            // Trigger reflow to ensure transition plays
            void alertBox.offsetWidth;
            alertBox.classList.add('show');

            setTimeout(() => {
                alertBox.classList.remove('show');
                alertBox.addEventListener('transitionend', function handler() {
                    alertBox.style.display = 'none';
                    alertBox.removeEventListener('transitionend', handler);
                });
            }, duration);
        }

        // Global variables for invoice data and autocomplete
        let allInvoiceNumbers = [];
        let allInvoiceData = [];
        let filteredInvoiceData = [];
        window.currentPage = 1;
        const itemsPerPage = 10;

        // Global variables to store unsubscribe functions for realtime listeners
        window.invoiceUnsubscribe = null;
        window.dashboardUnsubscribe = null;
        window.reportUnsubscribe = null;

        // Global variables for vendor data
        let allVendorNames = [];

        // Load vendor data
        async function loadVendorData() {
            try {
                const sampleVendors = [
                   "ALARM SUPPLY PTE LTD",
                   "ALLTECH SOLUSINDO",
                   "ALVASTA TEKNOLOGI",
                   "ARSITA UTAMA INDONESIA",
                   "ARSITA UTAMA INDONESIA. PT",
                   "ARTA KENCANA PRIMA MANDIRI",
                   "ASIA CIPTA MANAGEMENT",
                   "AUSTRALINDO GRAHA NUSA",
                   "BUANA SUKSES ABADI",
                   "BUANA SUKSES BERSAMA. PT",
                   "BUMEN CITRA MANDIRI",
                   "CAHAYA BUANA INDOABADI",
                   "CAHAYA KALIMAS UTAMA",
                   "CAKRA MITRA SENTOSA",
                   "CECEP DENI SAPUTRA",
                   "CITRA INTI SEMESTA",
                   "CV. BELTECHINDO",
                   "CV. PRIMA TIMUR JAYA",
                   "DAITO ELEKTRINDO",
                   "DENKO WAHANA SAKTI",
                   "DEXTRANS WORLWIDE INDONESIA. PT",
                   "ECONOMIE MANDIRI",
                   "ETIQA ASURANSI",
                   "FEDEX EXPRESS INTERNATIONAL",
                   "FFE LIMITED",
                   "GECA S.r.I",
                   "GENAIR NUSAINDO",
                   "HASEA CIPTA KARYA",
                   "HIKARI INDO SARANA. PT",
                   "HONEYWELL",
                   "HONEYWELL INDONESIA. PT",
                   "INTIKABEL METALINDO",
                   "ISTANA KEBON JERUK",
                   "KAMIL PUTRA PROTEKSINDO",
                   "KARYA GRAHA CAHAYA",
                   "KARYA GRAHA COMPUTER SUPERMALL",
                   "KIJANG SOLIDEO TEKNIK",
                   "LENTERA TILAS TEHNIK",
                   "MACRON SAFETY SYSTEMS (UK) LIMITED",
                   "MASTER INDO LOGISTICS. PT",
                   "MEDIA MITRA PRATAMA",
                   "METRO JAYA TEKNIK",
                   "MID SOLUSI NUSANTARA. PT",
                   "MITRA MAKMUR SOLUSINDO",
                   "MUHAMMAD FAIK",
                   "MULTRON SYSTEMS PTE. LTD",
                   "OBAY",
                   "PANAH PERDANA LOGISINDO. PT",
                   "PASKALIS",
                   "PETRA CONDUIT",
                   "PRIMA TIMUR JAYA",
                   "PRIMA TUNGGAL JAVALAND",
                   "PROTOCONVERT",
                   "PT TUNAS RIDEAN",
                   "SETYA REKAT ABADI. PT",
                   "SHOPPE INDONESIA",
                   "TEKNIK MAKMUR MANDIRI",
                   "TEPG",
                   "TOKOPEDIA",
                   "VINOTI (VIVERE MULTI KREASI)",
                   "WIDJAJA TEKNIK UTAMA. PT",
                   "YANTO. BPK",
                   "TIRTA INVESTAMA. PT",
                   "FATHONA MARFAZRINA",
                   "HEBEI J&R TRADING CO. LTD",
                   "CAHAYA DELTA MANDIRI",
                   "PRIMACIPTA UNGGUL KARYA",
                   "DATA INTEGRASI SEMESTA",
                   "GLOBAL SECURITY SERVICE INDONESIA",
                   "BERKAH MANDIRI PROTECTION",
                   "PELOPOR PRATAMA LANCAR ABADI",
                   "BETA PANEL",
                   "WARUNG NASI PASUNDAN",
                   "LUBNA PERKASA ABADI",
                   "SIBALEC. PT",
                   "13ROTHER MAFIA KONVEKSI",
                   "UNI NETWORK COMMUNICATIONS",
                   "DENKO WAHANA SAKTI",
                   "ISS INDONESIA",
                   "HORING LIH INDUSTRIAL",
                   "AKARA DIRAYA NAWASENA",
                   "PANDU BINA SENTOSA",
                   "KSO SUCOFINDO - SURVEYOR INDONESIA",
                   "CV KARYA HADIAH KREATIF",
                   "ALFIRE PRIMA INDONEISA",
                   "CITRA INTI SEMESTA",
                   "BAMBANG WINARNO. BPK",
                   "UMROTA KARYA UTAMA",
                   "KAP PIETER. UWAYS & REKAN",
                   "ELPRIMA KENCANA",
                   "BAHTERA BINA SELARAS",
                   "BINEX LOGISTIC",
                   "HOME CENTER INDONESIA RETAIL",
                   "BARAYA PROTEKSINDO ABADI", 
                   "ERAFONE ARTHA RETAILINDO",
                   "CV. AZZA BARAKAH SEJAHTERA",
                   "REJEKI PRIMA STEEL",
                   "SAMSIRA TEKNOLOGI INDONESIA",
                   "BINA GLOBAL TRANSPORT",
                   "ASENWARE INDONESIA JAYA",
                   "AZBIL BERCA INDONESIA",
                   "TEMAN BAIK. CV"
                ];
                
                allVendorNames = sampleVendors;
                setupVendorAutocomplete();
            } catch (error) {
                console.error("Error loading vendor data:", error);
                showAlert("Gagal memuat data vendor: " + error.message, 'error');
            }
        }

        // Setup vendor autocomplete
        function setupVendorAutocomplete() {
            const vendorInput = document.getElementById('invoice-nama-vendor');
            if (vendorInput && allVendorNames.length > 0) {
                autocomplete(vendorInput, allVendorNames);
            }
        }

        // Enhanced autocomplete function to handle multiple fields
        function autocomplete(inp, arr) {
            var currentFocus;
            inp.addEventListener("input", function(e) {
                var a, b, i, val = this.value;
                closeAllLists();
                if (val.length < 1) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                        b = document.createElement("DIV");
                        const matchIndex = arr[i].toUpperCase().indexOf(val.toUpperCase());
                        b.innerHTML = arr[i].substring(0, matchIndex) +
                            "<strong>" + arr[i].substring(matchIndex, matchIndex + val.length) + "</strong>" +
                            arr[i].substring(matchIndex + val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            inp.addEventListener("keydown", function(e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) {
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        // --- PERBAIKAN 1: Fungsi untuk membersihkan form saat modal dibuka ---
        function clearFormOnModalOpen(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Reset form ketika modal dibuka
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                
                // Setup autocomplete untuk input invoice number
                const invoiceInputs = modal.querySelectorAll('input[type="text"]');
                invoiceInputs.forEach(input => {
                    if (input.id.includes('invoice') || input.id.includes('search')) {
                        // Setup autocomplete untuk input invoice
                        autocomplete(input, allInvoiceNumbers);
                    }
                });
            }
        }

        // --- PERBAIKAN 2: Enhanced autocomplete setup untuk semua input invoice ---
        function setupAllAutocompletes() {
            const searchInvoiceFakturPajakInput = document.getElementById('search-invoice-faktur-pajak');
            const searchInvoicePembayaranInput = document.getElementById('search-invoice-pembayaran');
            const searchInvoiceKeteranganInput = document.getElementById('search-invoice-keterangan');
            const filterSearchInput = document.getElementById('filter-search');

            if (searchInvoiceFakturPajakInput) autocomplete(searchInvoiceFakturPajakInput, allInvoiceNumbers);
            if (searchInvoicePembayaranInput) autocomplete(searchInvoicePembayaranInput, allInvoiceNumbers);
            if (searchInvoiceKeteranganInput) autocomplete(searchInvoiceKeteranganInput, allInvoiceNumbers);
            if (filterSearchInput) autocomplete(filterSearchInput, allInvoiceNumbers);
            
            // Juga setup untuk input di modal
            const modalInvoiceInputs = document.querySelectorAll('#fp-no-invoice, #pembayaran-no-invoice, #keterangan-no-invoice');
            modalInvoiceInputs.forEach(input => {
                if (input) autocomplete(input, allInvoiceNumbers);
            });
        }

        // --- Fungsi untuk membersihkan No Invoice agar aman digunakan sebagai ID dokumen Firestore ---
        function sanitizeInvoiceNo(invoiceNo) {
            return invoiceNo.replace(/\//g, '-');
        }

        // --- Calculate Status Based on Dates ---
        function calculateStatus(tglDiterima, jatuhTempo, tglBayar, currentStatus, isManualStatusFromDB) {
            if (tglBayar) {
                return 'Dibayar';
            }

            if (isManualStatusFromDB && currentStatus) {
                return currentStatus;
            }

            if (!tglDiterima || !jatuhTempo) {
                return currentStatus || 'Belum Diproses';
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const receivedDate = new Date(tglDiterima);
            receivedDate.setHours(0, 0, 0, 0);

            const dueDate = new Date(jatuhTempo);
            dueDate.setHours(0, 0, 0, 0);

            if (today > dueDate) {
                return 'Jatuh Tempo';
            }

            const threeDaysBeforeDueDate = new Date(dueDate);
            threeDaysBeforeDueDate.setDate(dueDate.getDate() - 3);
            threeDaysBeforeDueDate.setHours(0, 0, 0, 0);

            if (today >= threeDaysBeforeDueDate && today <= dueDate) {
                return 'Menunggu Pembayaran';
            }

            const sevenDaysBeforeDueDate = new Date(dueDate);
            sevenDaysBeforeDueDate.setDate(dueDate.getDate() - 7);
            sevenDaysBeforeDueDate.setHours(0, 0, 0, 0);

            if (today >= sevenDaysBeforeDueDate && today < threeDaysBeforeDueDate) {
                return 'Menunggu Pengajuan';
            }

            return currentStatus || 'Belum Diproses';
        }

        // --- Render Invoices to Table ---
        function renderInvoicesTable(data) {
            const invoiceTableBody = document.querySelector('#invoice-table tbody');
            if (!invoiceTableBody) return;

            invoiceTableBody.innerHTML = '';

            if (data.length === 0) {
                invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Tidak ada data invoice yang cocok.</td></tr>';
                renderPagination(0, 0);
                return;
            }

            const startIndex = (window.currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            let rowNum = startIndex + 1;
            const rowsHtml = [];

            paginatedData.forEach(invoice => {
                let statusClass = '';
                if (invoice.Status === 'Dibayar') statusClass = 'status-paid';
                else if (['Menunggu Pembayaran'].includes(invoice.Status)) statusClass = 'status-pending';
                else if (invoice.Status === 'Jatuh Tempo') statusClass = 'status-overdue';
                else if (['Diajukan ke Finance'].includes(invoice.Status)) statusClass = 'status-diajukan-finance';
                else if (['Diterima Anggi'].includes(invoice.Status)) statusClass = 'status-diterima-anggi';
                else if (['Dibatalkan'].includes(invoice.Status)) statusClass = 'status-dibatalkan';
                else if (['Menunggu Pengajuan', 'Belum Diproses'].includes(invoice.Status)) statusClass = 'status-menunggu-pengajuan';

                rowsHtml.push(`
                    <tr data-invoice-id="${invoice.No_Invoice}">
                        <td>${rowNum++}</td>
                        <td>${invoice.Email_Hard || '-'}</td>
                        <td>${invoice.Penerima || '-'}</td>
                        <td>${invoice.Corp || '-'}</td>
                        <td>${invoice.Tanggal_Diterima || '-'}</td>
                        <td><a href="#" class="view-invoice-detail" data-invoice-no="${invoice.No_Invoice}">${invoice.No_Invoice}</a></td>
                        <td>${invoice.Nama_Vendor || '-'}</td>
                        <td>${invoice.DPP_IDR}</td>
                        <td>
                            <button class="status-button ${statusClass}" data-invoice-no="${invoice.No_Invoice}" data-current-status="${invoice.Status}">
                                ${invoice.Status}
                            </button>
                        </td>
                        <td class="action-cell">
                            <button class="action-btn edit-invoice-btn" data-invoice-no="${invoice.No_Invoice}" title="Edit Invoice"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-invoice-btn" data-invoice-no="${invoice.No_Invoice}" title="Hapus Invoice"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
            invoiceTableBody.innerHTML = rowsHtml.join('');
            renderPagination(data.length, window.currentPage);
            
            // Add event listeners to action buttons
            setTimeout(() => {
                setupTableActionListeners();
            }, 100);
        }

        // --- Setup Table Action Listeners ---
        function setupTableActionListeners() {
            // Edit buttons
            document.querySelectorAll('.edit-invoice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceNo = this.getAttribute('data-invoice-no');
                    editInvoice(invoiceNo);
                });
            });

            // Delete buttons
            document.querySelectorAll('.delete-invoice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceNo = this.getAttribute('data-invoice-no');
                    deleteInvoice(invoiceNo);
                });
            });

            // Status buttons
            document.querySelectorAll('.status-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceNo = this.getAttribute('data-invoice-no');
                    const currentStatus = this.getAttribute('data-current-status');
                    openStatusModal(invoiceNo, currentStatus);
                });
            });

            // View detail links - FIXED: Added proper event listeners
            document.querySelectorAll('.view-invoice-detail').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const invoiceNo = this.getAttribute('data-invoice-no');
                    viewInvoiceDetail(invoiceNo);
                });
            });
        }

        // --- Render Pagination Controls ---
        function renderPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pageControls = document.querySelector('.pagination .page-controls');
            const pageInfo = document.querySelector('.pagination .page-info');
            pageControls.innerHTML = '';

            if (totalItems === 0) {
                pageInfo.textContent = 'Menampilkan 0-0 dari 0 data';
                return;
            }

            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            pageInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (window.currentPage > 1) {
                    window.currentPage--;
                    renderInvoicesTable(filteredInvoiceData);
                }
            });
            pageControls.appendChild(prevBtn);

            // Page numbers
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }

            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'page-btn';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => {
                    window.currentPage = 1;
                    renderInvoicesTable(filteredInvoiceData);
                });
                pageControls.appendChild(firstPageBtn);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pageControls.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    window.currentPage = i;
                    renderInvoicesTable(filteredInvoiceData);
                });
                pageControls.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pageControls.appendChild(dots);
                }
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'page-btn';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => {
                    window.currentPage = totalPages;
                    renderInvoicesTable(filteredInvoiceData);
                });
                pageControls.appendChild(lastPageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (window.currentPage < totalPages) {
                    window.currentPage++;
                    renderInvoicesTable(filteredInvoiceData);
                }
            });
            pageControls.appendChild(nextBtn);
        }

        // --- Load Invoices to Table ---
        async function loadInvoicesToTable() {
            const invoiceTableBody = document.querySelector('#invoice-table tbody');
            if (!invoiceTableBody) return;

            invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Memuat data...</td></tr>';
            allInvoiceNumbers = [];

            try {
                if (window.invoiceUnsubscribe) {
                    window.invoiceUnsubscribe();
                }

                window.invoiceUnsubscribe = invoicesCol.onSnapshot(async (snapshot) => {
                    if (snapshot.empty) {
                        invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Tidak ada data invoice.</td></tr>';
                        allInvoiceNumbers = [];
                        allInvoiceData = [];
                        filteredInvoiceData = [];
                        renderPagination(0, 0);
                        return;
                    }

                    let rowNum = 1;
                    const currentAllInvoiceData = [];
                    const currentInvoiceNumbers = [];

                    const [pembayaranSnapshot, keteranganSnapshot] = await Promise.all([
                        pembayaranCol.get(),
                        keteranganCol.get()
                    ]);

                    const pembayaranMap = new Map();
                    pembayaranSnapshot.forEach(doc => {
                        pembayaranMap.set(doc.data().noInvoice, doc.data());
                    });

                    const keteranganMap = new Map();
                    keteranganSnapshot.forEach(doc => {
                        keteranganMap.set(doc.data().noInvoice, doc.data());
                    });

                    snapshot.forEach(doc => {
                        const invoice = doc.data();
                        const noInvoice = invoice.noInvoice;
                        currentInvoiceNumbers.push(noInvoice);

                        const pembayaran = pembayaranMap.get(noInvoice) || {};
                        const keterangan = keteranganMap.get(noInvoice) || {};

                        const dppDisplay = pembayaran.dppIdr ? formatRupiah(pembayaran.dppIdr) : 'N/A';
                        const statusDisplay = calculateStatus(
                            invoice.tglDiterima,
                            pembayaran.jatuhTempo,
                            keterangan.tglBayar,
                            keterangan.statusAkhir,
                            keterangan.isManualStatus || false
                        );
                        
                        currentAllInvoiceData.push({
                            No: rowNum++,
                            Email_Hard: invoice.emailHard || '',
                            Penerima: invoice.penerima || '',
                            Corp: invoice.corp || '',
                            Tanggal_Diterima: invoice.tglDiterima || '',
                            No_Invoice: noInvoice,
                            Nama_Vendor: invoice.namaVendor || '',
                            DPP_IDR: dppDisplay,
                            PPn_IDR: pembayaran.ppnIdr || '0',
                            DPP_USD: pembayaran.dppUsd || '0',
                            Keterangan_Pembayaran: pembayaran.keterangan || '',
                            Follow_Up: pembayaran.followUp || '',
                            Hasil_Follow_Up: pembayaran.hasilFollowUp || '',
                            TOP: pembayaran.top || '',
                            Jatuh_Tempo: pembayaran.jatuhTempo || '',
                            Tanggal_Pengajuan_Finance: keterangan.tglPengajuanFinance || '',
                            Tanggal_Pengajuan_Reni: keterangan.tglPengajuanReni || '',
                            Tanggal_Diterima_Anggi: keterangan.tglDiterimaAnggi || '',
                            Lama_Pengajuan: keterangan.lamaPengajuan || '',
                            Keterangan_Proses: keterangan.keteranganProses || '',
                            Tanggal_Bayar: keterangan.tglBayar || '',
                            Status: statusDisplay,
                            Is_Manual_Status: keterangan.isManualStatus || false
                        });
                    });
                    allInvoiceData = currentAllInvoiceData;
                    allInvoiceNumbers = currentInvoiceNumbers;
                    setupAllAutocompletes();
                    applyFilters();
                }, (error) => {
                    console.error("Error loading invoices: ", error);
                    invoiceTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: var(--danger);">Gagal memuat data: ${error.message}</td></tr>`;
                    showAlert("Gagal memuat data invoice: " + error.message, 'error');
                });
            } catch (error) {
                console.error("Error setting up invoice listener: ", error);
                invoiceTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: var(--danger);">Gagal memuat data: ${error.message}</td></tr>`;
                showAlert("Gagal memuat data invoice: " + error.message, 'error');
            }
        }

        // --- Apply Filters Function ---
        function applyFilters() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const statusFilter = document.getElementById('filter-status').value;
            const searchKeyword = document.getElementById('filter-search').value.toLowerCase();

            filteredInvoiceData = allInvoiceData.filter(invoice => {
                let matches = true;

                if (startDate && invoice.Tanggal_Diterima < startDate) {
                    matches = false;
                }
                if (endDate && invoice.Tanggal_Diterima > endDate) {
                    matches = false;
                }

                if (statusFilter && statusFilter !== '' && invoice.Status !== statusFilter) {
                    matches = false;
                }

                if (searchKeyword) {
                    const searchableFields = [
                        invoice.No_Invoice,
                        invoice.Nama_Vendor,
                        invoice.Penerima,
                        invoice.Corp,
                        invoice.Status
                    ];
                    const keywordMatch = searchableFields.some(field =>
                        String(field).toLowerCase().includes(searchKeyword)
                    );
                    if (!keywordMatch) {
                        matches = false;
                    }
                }

                return matches;
            });

            window.currentPage = 1;
            renderInvoicesTable(filteredInvoiceData);
        }

        // --- Load Dashboard Data ---
        async function loadDashboardData() {
            const totalInvoiceEl = document.getElementById('dashboard-total-invoice');
            const paidInvoiceEl = document.getElementById('dashboard-paid-invoice');
            const pendingInvoiceEl = document.getElementById('dashboard-pending-invoice');
            const submissionPendingInvoiceEl = document.getElementById('dashboard-submission-pending-invoice');
            const overdueInvoiceEl = document.getElementById('dashboard-overdue-invoice');

            if (!totalInvoiceEl || !paidInvoiceEl || !pendingInvoiceEl || !overdueInvoiceEl || !submissionPendingInvoiceEl) return;

            totalInvoiceEl.textContent = '...';
            paidInvoiceEl.textContent = '...';
            pendingInvoiceEl.textContent = '...';
            submissionPendingInvoiceEl.textContent = '...';
            overdueInvoiceEl.textContent = '...';

            try {
                if (window.dashboardUnsubscribe) {
                    window.dashboardUnsubscribe();
                }

                window.dashboardUnsubscribe = invoicesCol.onSnapshot(async (snapshot) => {
                    let total = 0;
                    let paid = 0;
                    let pending = 0;
                    let submissionPending = 0;
                    let overdue = 0;

                    if (!snapshot.empty) {
                        total = snapshot.size;
                        const [pembayaranSnapshot, keteranganSnapshot] = await Promise.all([
                            pembayaranCol.get(),
                            keteranganCol.get()
                        ]);

                        const pembayaranMap = new Map();
                        pembayaranSnapshot.forEach(doc => {
                            pembayaranMap.set(doc.data().noInvoice, doc.data());
                        });

                        const keteranganMap = new Map();
                        keteranganSnapshot.forEach(doc => {
                            keteranganMap.set(doc.data().noInvoice, doc.data());
                        });

                        snapshot.forEach(doc => {
                            const noInvoice = doc.data().noInvoice;
                            const invoiceData = doc.data();
                            const pembayaran = pembayaranMap.get(noInvoice) || {};
                            const keterangan = keteranganMap.get(noInvoice) || {};

                            const status = calculateStatus(
                                invoiceData.tglDiterima,
                                pembayaran.jatuhTempo,
                                keterangan.tglBayar,
                                keterangan.statusAkhir,
                                keterangan.isManualStatus || false
                            );

                            if (status === 'Dibayar') {
                                paid++;
                            } else if (status === 'Menunggu Pembayaran') {
                                pending++;
                            } else if (status === 'Menunggu Pengajuan') {
                                submissionPending++;
                            } else if (status === 'Jatuh Tempo') {
                                overdue++;
                            }
                        });
                    }

                    totalInvoiceEl.textContent = total;
                    paidInvoiceEl.textContent = paid;
                    pendingInvoiceEl.textContent = pending;
                    submissionPendingInvoiceEl.textContent = submissionPending;
                    overdueInvoiceEl.textContent = overdue;
                }, (error) => {
                    console.error("Error loading dashboard data: ", error);
                    showAlert("Gagal memuat data dashboard: " + error.message, 'error');
                    totalInvoiceEl.textContent = 'Error';
                    paidInvoiceEl.textContent = 'Error';
                    pendingInvoiceEl.textContent = 'Error';
                    submissionPendingInvoiceEl.textContent = 'Error';
                    overdueInvoiceEl.textContent = 'Error';
                });

            } catch (error) {
                console.error("Error setting up dashboard listener: ", error);
                showAlert("Gagal memuat data dashboard: " + error.message, 'error');
                totalInvoiceEl.textContent = 'Error';
                paidInvoiceEl.textContent = 'Error';
                pendingInvoiceEl.textContent = 'Error';
                submissionPendingInvoiceEl.textContent = 'Error';
                overdueInvoiceEl.textContent = 'Error';
            }
        }

        // --- Format Rupiah Function ---
        function formatRupiah(angka, prefix = '') {
            let number_string = angka.toString().replace(/[^,\d]/g, ''),
                split = number_string.split(','),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);

            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }

            rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
            return prefix == undefined ? rupiah : (rupiah ? 'Rp ' + rupiah : '');
        }

        // --- Event Listener for Rupiah Input Formatting ---
        function setupRupiahInput(inputId) {
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                inputElement.addEventListener('keyup', function(e) {
                    inputElement.value = formatRupiah(this.value);
                });
                inputElement.addEventListener('blur', function(e) {
                    inputElement.value = formatRupiah(this.value);
                });
            }
        }

        // --- Fungsi untuk menghitung PPN otomatis ---
        function calculatePPN() {
            const dppIdrInput = document.getElementById('pembayaran-dpp-idr');
            const ppnIdrInput = document.getElementById('pembayaran-ppn-idr');
            const includePPNCheckbox = document.getElementById('pembayaran-include-ppn');
            
            if (!dppIdrInput || !ppnIdrInput || !includePPNCheckbox) return;
            
            const dppValue = dppIdrInput.value.replace(/[^0-9]/g, '');
            
            if (dppValue && includePPNCheckbox.checked) {
                const dppNumber = parseInt(dppValue);
                const ppnAmount = Math.round(dppNumber * 0.11);
                ppnIdrInput.value = formatRupiah(ppnAmount.toString());
            } else if (includePPNCheckbox.checked === false) {
                ppnIdrInput.value = '';
            }
        }

        // --- Improved Login Functionality ---
        function initLogin() {
            const loginForm = document.getElementById('login-form');
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');

            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }

            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('main-container').style.display = 'flex';
                    loadDashboardData();
                    loadVendorData();
                    showSection('dashboard-section');
                } else {
                    document.getElementById('auth-container').style.display = 'flex';
                    document.getElementById('main-container').style.display = 'none';
                }
            });
        }

        function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');

            loginBtn.classList.add('loading');
            loginError.style.display = 'none';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    loginBtn.classList.remove('loading');
                    showAlert('Login berhasil!', 'success');
                })
                .catch((error) => {
                    loginBtn.classList.remove('loading');
                    let errorMessage = 'Email atau password salah.';
                    
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Password yang Anda masukkan salah.';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Email tidak ditemukan.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Format email tidak valid.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Terlalu banyak percobaan login. Coba lagi nanti.';
                    }
                    
                    loginError.textContent = errorMessage;
                    loginError.style.display = 'block';
                    console.error("Login error:", error);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                showAlert('Logout berhasil!', 'success');
            }).catch((error) => {
                console.error("Logout error:", error);
            });
        }

        // --- Fungsi Navigasi Sidebar ---
        function showSection(targetId) {
            const contentSections = document.querySelectorAll('.content-section');
            const navItems = document.querySelectorAll('.nav-item');
            
            contentSections.forEach(section => {
                section.style.display = 'none';
            });
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            navItems.forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-target="${targetId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            if (targetId === 'dashboard-section') {
                loadDashboardData();
            } else if (targetId === 'invoice-list-section') {
                loadInvoicesToTable();
            }
        }

        // Setup modal functionality
        function setupModals() {
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('.modal-close-btn');
            
            window.openModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // --- PERBAIKAN 1: Clear form saat modal dibuka ---
                    clearFormOnModalOpen(modalId);
                    
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            };
            
            window.closeModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            };
            
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    modals.forEach(modal => {
                        if (modal.style.display === 'flex') {
                            closeModal(modal.id);
                        }
                    });
                }
            });
        }

        // Setup event listeners for buttons
        function setupButtonListeners() {
            // Tambah Invoice button
            const addInvoiceBtn = document.getElementById('add-invoice-btn');
            if (addInvoiceBtn) {
                addInvoiceBtn.addEventListener('click', function() {
                    openModal('invoice-modal');
                    resetInvoiceForm();
                });
            }
            
            // Filter button
            const filterBtn = document.querySelector('.btn-primary .fa-filter')?.closest('.btn');
            if (filterBtn) {
                filterBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    applyFilters();
                });
            }
            
            // Export button
            const exportBtn = document.querySelector('.export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    exportInvoices();
                });
            }

            // Faktur Pajak buttons
            const searchFakturPajakBtn = document.getElementById('search-faktur-pajak-btn');
            if (searchFakturPajakBtn) {
                searchFakturPajakBtn.addEventListener('click', function() {
                    const invoiceNo = document.getElementById('search-invoice-faktur-pajak').value;
                    if (invoiceNo) {
                        openFakturPajakModal(invoiceNo);
                    } else {
                        showAlert('Harap pilih invoice terlebih dahulu!', 'error');
                    }
                });
            }

            const addFakturPajakStandaloneBtn = document.getElementById('add-faktur-pajak-standalone-btn');
            if (addFakturPajakStandaloneBtn) {
                addFakturPajakStandaloneBtn.addEventListener('click', function() {
                    openModal('faktur-pajak-modal');
                    resetFakturPajakForm();
                });
            }

            // Pembayaran buttons
            const searchPembayaranBtn = document.getElementById('search-pembayaran-btn');
            if (searchPembayaranBtn) {
                searchPembayaranBtn.addEventListener('click', function() {
                    const invoiceNo = document.getElementById('search-invoice-pembayaran').value;
                    if (invoiceNo) {
                        openPembayaranModal(invoiceNo);
                    } else {
                        showAlert('Harap pilih invoice terlebih dahulu!', 'error');
                    }
                });
            }

            const addPembayaranStandaloneBtn = document.getElementById('add-pembayaran-standalone-btn');
            if (addPembayaranStandaloneBtn) {
                addPembayaranStandaloneBtn.addEventListener('click', function() {
                    openModal('pembayaran-modal');
                    resetPembayaranForm();
                });
            }

            // Keterangan buttons
            const searchKeteranganBtn = document.getElementById('search-keterangan-btn');
            if (searchKeteranganBtn) {
                searchKeteranganBtn.addEventListener('click', function() {
                    const invoiceNo = document.getElementById('search-invoice-keterangan').value;
                    if (invoiceNo) {
                        openKeteranganModal(invoiceNo);
                    } else {
                        showAlert('Harap pilih invoice terlebih dahulu!', 'error');
                    }
                });
            }

            const addKeteranganStandaloneBtn = document.getElementById('add-keterangan-standalone-btn');
            if (addKeteranganStandaloneBtn) {
                addKeteranganStandaloneBtn.addEventListener('click', function() {
                    openModal('keterangan-modal');
                    resetKeteranganForm();
                });
            }

            // Back to list button in detail section
            const backToListBtn = document.getElementById('back-to-list-btn');
            if (backToListBtn) {
                backToListBtn.addEventListener('click', function() {
                    showSection('invoice-list-section');
                });
            }

            // Setup form submissions
            const invoiceForm = document.getElementById('invoice-form');
            if (invoiceForm) {
                invoiceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveInvoice();
                });
            }

            const fakturPajakForm = document.getElementById('faktur-pajak-form');
            if (fakturPajakForm) {
                fakturPajakForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveFakturPajak();
                });
            }

            const pembayaranForm = document.getElementById('pembayaran-form');
            if (pembayaranForm) {
                pembayaranForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    savePembayaran();
                });
            }

            const keteranganForm = document.getElementById('keterangan-form');
            if (keteranganForm) {
                keteranganForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveKeterangan();
                });
            }

            const statusForm = document.getElementById('status-form');
            if (statusForm) {
                statusForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveStatusManual();
                });
            }

            // Setup PPN calculation
            const includePPNCheckbox = document.getElementById('pembayaran-include-ppn');
            if (includePPNCheckbox) {
                includePPNCheckbox.addEventListener('change', calculatePPN);
            }

            const dppIdrInput = document.getElementById('pembayaran-dpp-idr');
            if (dppIdrInput) {
                dppIdrInput.addEventListener('input', calculatePPN);
            }
        }

        // Reset forms
        function resetInvoiceForm() {
            const form = document.getElementById('invoice-form');
            if (form) {
                form.reset();
            }
        }

        function resetFakturPajakForm() {
            const form = document.getElementById('faktur-pajak-form');
            if (form) {
                form.reset();
            }
        }

        function resetPembayaranForm() {
            const form = document.getElementById('pembayaran-form');
            if (form) {
                form.reset();
            }
        }

        function resetKeteranganForm() {
            const form = document.getElementById('keterangan-form');
            if (form) {
                form.reset();
            }
        }

        // Open modals with data
        function openFakturPajakModal(invoiceNo) {
            document.getElementById('fp-no-invoice').value = invoiceNo;
            openModal('faktur-pajak-modal');
            
            // Load existing data if available
            loadFakturPajakData(invoiceNo);
        }

        function openPembayaranModal(invoiceNo) {
            document.getElementById('pembayaran-no-invoice').value = invoiceNo;
            openModal('pembayaran-modal');
            
            // Load existing data if available
            loadPembayaranData(invoiceNo);
        }

        function openKeteranganModal(invoiceNo) {
            document.getElementById('keterangan-no-invoice').value = invoiceNo;
            openModal('keterangan-modal');
            
            // Load existing data if available
            loadKeteranganData(invoiceNo);
        }

        function openStatusModal(invoiceNo, currentStatus) {
            document.getElementById('status-no-invoice').value = invoiceNo;
            document.getElementById('status-manual-select').value = currentStatus;
            openModal('status-modal');
        }

        // Load existing data functions
        async function loadFakturPajakData(invoiceNo) {
            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(invoiceNo);
                const doc = await fakturPajakCol.doc(sanitizedInvoiceNo).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('fp-tgl-faktur-pajak').value = data.tglFakturPajak || '';
                    document.getElementById('fp-no-faktur-pajak').value = data.noFakturPajak || '';
                }
            } catch (error) {
                console.error("Error loading faktur pajak data:", error);
            }
        }

        async function loadPembayaranData(invoiceNo) {
            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(invoiceNo);
                const doc = await pembayaranCol.doc(sanitizedInvoiceNo).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('pembayaran-dpp-idr').value = data.dppIdr ? formatRupiah(data.dppIdr.toString()) : '';
                    document.getElementById('pembayaran-ppn-idr').value = data.ppnIdr ? formatRupiah(data.ppnIdr.toString()) : '';
                    document.getElementById('pembayaran-dpp-usd').value = data.dppUsd || '';
                    document.getElementById('pembayaran-keterangan').value = data.keterangan || '';
                    document.getElementById('pembayaran-follow-up').value = data.followUp || 'Tidak';
                    document.getElementById('pembayaran-hasil-follow-up').value = data.hasilFollowUp || '';
                    document.getElementById('pembayaran-top').value = data.top || '';
                    document.getElementById('pembayaran-jatuh-tempo').value = data.jatuhTempo || '';
                }
            } catch (error) {
                console.error("Error loading pembayaran data:", error);
            }
        }

        async function loadKeteranganData(invoiceNo) {
            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(invoiceNo);
                const doc = await keteranganCol.doc(sanitizedInvoiceNo).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('keterangan-tgl-pengajuan-finance').value = data.tglPengajuanFinance || '';
                    document.getElementById('keterangan-tgl-pengajuan-reni').value = data.tglPengajuanReni || '';
                    document.getElementById('keterangan-tgl-diterima-anggi').value = data.tglDiterimaAnggi || '';
                    document.getElementById('keterangan-lama-pengajuan').value = data.lamaPengajuan || '';
                    document.getElementById('keterangan-keterangan-proses').value = data.keteranganProses || '';
                    document.getElementById('keterangan-tgl-bayar').value = data.tglBayar || '';
                    document.getElementById('keterangan-status-akhir').value = data.statusAkhir || '';
                }
            } catch (error) {
                console.error("Error loading keterangan data:", error);
            }
        }

        // Save functions
        async function saveInvoice() {
            const emailHard = document.getElementById('invoice-email-hard').value;
            const penerima = document.getElementById('invoice-penerima').value;
            const corp = document.getElementById('invoice-corp').value;
            const tglDiterima = document.getElementById('invoice-tgl-diterima').value;
            const tglInvoice = document.getElementById('invoice-tgl-invoice').value;
            const suratJalan = document.getElementById('invoice-surat-jalan').value;
            const namaVendor = document.getElementById('invoice-nama-vendor').value;
            const noInvoice = document.getElementById('invoice-no-invoice').value;

            if (!emailHard || !penerima || !corp || !tglDiterima || !tglInvoice || !namaVendor || !noInvoice) {
                showAlert('Harap isi semua field yang wajib diisi!', 'error');
                return;
            }

            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(noInvoice);
                
                await invoicesCol.doc(sanitizedInvoiceNo).set({
                    emailHard: emailHard,
                    penerima: penerima,
                    corp: corp,
                    tglDiterima: tglDiterima,
                    tglInvoice: tglInvoice,
                    suratJalan: suratJalan,
                    namaVendor: namaVendor,
                    noInvoice: noInvoice,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert('Invoice berhasil disimpan!', 'success');
                closeModal('invoice-modal');
                loadInvoicesToTable();
            } catch (error) {
                console.error("Error saving invoice: ", error);
                showAlert('Gagal menyimpan invoice: ' + error.message, 'error');
            }
        }

        async function saveFakturPajak() {
            const noInvoice = document.getElementById('fp-no-invoice').value;
            const tglFakturPajak = document.getElementById('fp-tgl-faktur-pajak').value;
            const noFakturPajak = document.getElementById('fp-no-faktur-pajak').value;

            if (!noInvoice || !tglFakturPajak || !noFakturPajak) {
                showAlert('Harap isi semua field yang wajib diisi!', 'error');
                return;
            }

            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(noInvoice);
                
                await fakturPajakCol.doc(sanitizedInvoiceNo).set({
                    noInvoice: noInvoice,
                    tglFakturPajak: tglFakturPajak,
                    noFakturPajak: noFakturPajak,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showAlert('Faktur Pajak berhasil disimpan!', 'success');
                closeModal('faktur-pajak-modal');
            } catch (error) {
                console.error("Error saving faktur pajak: ", error);
                showAlert('Gagal menyimpan faktur pajak: ' + error.message, 'error');
            }
        }

        async function savePembayaran() {
            const noInvoice = document.getElementById('pembayaran-no-invoice').value;
            const dppIdr = document.getElementById('pembayaran-dpp-idr').value.replace(/[^0-9]/g, '');
            const ppnIdr = document.getElementById('pembayaran-ppn-idr').value.replace(/[^0-9]/g, '');
            const dppUsd = document.getElementById('pembayaran-dpp-usd').value;
            const keterangan = document.getElementById('pembayaran-keterangan').value;
            const followUp = document.getElementById('pembayaran-follow-up').value;
            const hasilFollowUp = document.getElementById('pembayaran-hasil-follow-up').value;
            const top = document.getElementById('pembayaran-top').value;
            const jatuhTempo = document.getElementById('pembayaran-jatuh-tempo').value;

            if (!noInvoice || !dppIdr) {
                showAlert('Harap isi No Invoice dan DPP IDR!', 'error');
                return;
            }

            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(noInvoice);
                
                await pembayaranCol.doc(sanitizedInvoiceNo).set({
                    noInvoice: noInvoice,
                    dppIdr: parseInt(dppIdr) || 0,
                    ppnIdr: parseInt(ppnIdr) || 0,
                    dppUsd: parseFloat(dppUsd) || 0,
                    keterangan: keterangan,
                    followUp: followUp,
                    hasilFollowUp: hasilFollowUp,
                    top: top,
                    jatuhTempo: jatuhTempo,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showAlert('Data pembayaran berhasil disimpan!', 'success');
                closeModal('pembayaran-modal');
            } catch (error) {
                console.error("Error saving pembayaran: ", error);
                showAlert('Gagal menyimpan data pembayaran: ' + error.message, 'error');
            }
        }

        async function saveKeterangan() {
            const noInvoice = document.getElementById('keterangan-no-invoice').value;
            const tglPengajuanFinance = document.getElementById('keterangan-tgl-pengajuan-finance').value;
            const tglPengajuanReni = document.getElementById('keterangan-tgl-pengajuan-reni').value;
            const tglDiterimaAnggi = document.getElementById('keterangan-tgl-diterima-anggi').value;
            const keteranganProses = document.getElementById('keterangan-keterangan-proses').value;
            const tglBayar = document.getElementById('keterangan-tgl-bayar').value;
            const statusAkhir = document.getElementById('keterangan-status-akhir').value;

            if (!noInvoice) {
                showAlert('Harap isi No Invoice!', 'error');
                return;
            }

            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(noInvoice);
                
                let lamaPengajuan = '';
                if (tglPengajuanFinance && tglDiterimaAnggi) {
                    const startDate = new Date(tglPengajuanFinance);
                    const endDate = new Date(tglDiterimaAnggi);
                    const diffTime = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    lamaPengajuan = diffDays + ' hari';
                }

                await keteranganCol.doc(sanitizedInvoiceNo).set({
                    noInvoice: noInvoice,
                    tglPengajuanFinance: tglPengajuanFinance,
                    tglPengajuanReni: tglPengajuanReni,
                    tglDiterimaAnggi: tglDiterimaAnggi,
                    lamaPengajuan: lamaPengajuan,
                    keteranganProses: keteranganProses,
                    tglBayar: tglBayar,
                    statusAkhir: statusAkhir,
                    isManualStatus: !!statusAkhir,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showAlert('Data keterangan berhasil disimpan!', 'success');
                closeModal('keterangan-modal');
            } catch (error) {
                console.error("Error saving keterangan: ", error);
                showAlert('Gagal menyimpan data keterangan: ' + error.message, 'error');
            }
        }

        async function saveStatusManual() {
            const noInvoice = document.getElementById('status-no-invoice').value;
            const statusManual = document.getElementById('status-manual-select').value;

            if (!noInvoice || !statusManual) {
                showAlert('Harap isi semua field!', 'error');
                return;
            }

            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(noInvoice);
                
                await keteranganCol.doc(sanitizedInvoiceNo).set({
                    noInvoice: noInvoice,
                    statusAkhir: statusManual,
                    isManualStatus: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showAlert('Status berhasil diperbarui!', 'success');
                closeModal('status-modal');
                loadInvoicesToTable();
            } catch (error) {
                console.error("Error saving status: ", error);
                showAlert('Gagal menyimpan status: ' + error.message, 'error');
            }
        }

        // Other functions
        async function editInvoice(invoiceNo) {
            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(invoiceNo);
                const doc = await invoicesCol.doc(sanitizedInvoiceNo).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('invoice-email-hard').value = data.emailHard || '';
                    document.getElementById('invoice-penerima').value = data.penerima || '';
                    document.getElementById('invoice-corp').value = data.corp || '';
                    document.getElementById('invoice-tgl-diterima').value = data.tglDiterima || '';
                    document.getElementById('invoice-tgl-invoice').value = data.tglInvoice || '';
                    document.getElementById('invoice-surat-jalan').value = data.suratJalan || '';
                    document.getElementById('invoice-nama-vendor').value = data.namaVendor || '';
                    document.getElementById('invoice-no-invoice').value = data.noInvoice || '';
                    
                    openModal('invoice-modal');
                }
            } catch (error) {
                console.error("Error loading invoice for edit:", error);
                showAlert('Gagal memuat data invoice untuk diedit', 'error');
            }
        }

        async function deleteInvoice(invoiceNo) {
            if (confirm(`Apakah Anda yakin ingin menghapus invoice ${invoiceNo}?`)) {
                try {
                    const sanitizedInvoiceNo = sanitizeInvoiceNo(invoiceNo);
                    await invoicesCol.doc(sanitizedInvoiceNo).delete();
                    showAlert('Invoice berhasil dihapus!', 'success');
                    loadInvoicesToTable();
                } catch (error) {
                    console.error("Error deleting invoice:", error);
                    showAlert('Gagal menghapus invoice: ' + error.message, 'error');
                }
            }
        }

        // --- PERBAIKAN 3: Enhanced viewInvoiceDetail function ---
        async function viewInvoiceDetail(invoiceNo) {
            try {
                const sanitizedInvoiceNo = sanitizeInvoiceNo(invoiceNo);
                
                // Load data from all collections
                const [invoiceDoc, fakturPajakDoc, pembayaranDoc, keteranganDoc] = await Promise.all([
                    invoicesCol.doc(sanitizedInvoiceNo).get(),
                    fakturPajakCol.doc(sanitizedInvoiceNo).get(),
                    pembayaranCol.doc(sanitizedInvoiceNo).get(),
                    keteranganCol.doc(sanitizedInvoiceNo).get()
                ]);

                if (!invoiceDoc.exists) {
                    showAlert('Invoice tidak ditemukan!', 'error');
                    return;
                }

                const invoiceData = invoiceDoc.data();
                const fakturPajakData = fakturPajakDoc.exists ? fakturPajakDoc.data() : {};
                const pembayaranData = pembayaranDoc.exists ? pembayaranDoc.data() : {};
                const keteranganData = keteranganDoc.exists ? keteranganDoc.data() : {};

                // Update detail section header
                document.getElementById('detail-invoice-no').textContent = invoiceNo;

                // Fill basic invoice information
                document.getElementById('detail-email-hard').textContent = invoiceData.emailHard || '-';
                document.getElementById('detail-penerima').textContent = invoiceData.penerima || '-';
                document.getElementById('detail-corp').textContent = invoiceData.corp || '-';
                document.getElementById('detail-tgl-diterima').textContent = invoiceData.tglDiterima || '-';
                document.getElementById('detail-tgl-invoice').textContent = invoiceData.tglInvoice || '-';
                document.getElementById('detail-surat-jalan').textContent = invoiceData.suratJalan || '-';
                document.getElementById('detail-nama-vendor').textContent = invoiceData.namaVendor || '-';

                // Fill faktur pajak information
                document.getElementById('detail-no-faktur-pajak').textContent = fakturPajakData.noFakturPajak || '-';
                document.getElementById('detail-tgl-faktur-pajak').textContent = fakturPajakData.tglFakturPajak || '-';

                // Fill pembayaran information
                document.getElementById('detail-dpp-idr').textContent = pembayaranData.dppIdr ? formatRupiah(pembayaranData.dppIdr.toString()) : '-';
                document.getElementById('detail-ppn-idr').textContent = pembayaranData.ppnIdr ? formatRupiah(pembayaranData.ppnIdr.toString()) : '-';
                document.getElementById('detail-dpp-usd').textContent = pembayaranData.dppUsd || '-';
                document.getElementById('detail-keterangan-pembayaran').textContent = pembayaranData.keterangan || '-';
                document.getElementById('detail-follow-up').textContent = pembayaranData.followUp || '-';
                document.getElementById('detail-hasil-follow-up').textContent = pembayaranData.hasilFollowUp || '-';
                document.getElementById('detail-top').textContent = pembayaranData.top || '-';
                document.getElementById('detail-jatuh-tempo').textContent = pembayaranData.jatuhTempo || '-';

                // Fill keterangan information
                document.getElementById('detail-tgl-pengajuan-finance').textContent = keteranganData.tglPengajuanFinance || '-';
                document.getElementById('detail-tgl-pengajuan-reni').textContent = keteranganData.tglPengajuanReni || '-';
                document.getElementById('detail-tgl-diterima-anggi').textContent = keteranganData.tglDiterimaAnggi || '-';
                document.getElementById('detail-lama-pengajuan').textContent = keteranganData.lamaPengajuan || '-';
                document.getElementById('detail-keterangan-proses').textContent = keteranganData.keteranganProses || '-';
                document.getElementById('detail-tgl-bayar').textContent = keteranganData.tglBayar || '-';
                document.getElementById('detail-status-akhir').textContent = keteranganData.statusAkhir || '-';

                // Show detail section
                showSection('invoice-detail-section');

            } catch (error) {
                console.error("Error loading invoice detail:", error);
                showAlert('Gagal memuat detail invoice: ' + error.message, 'error');
            }
        }

        function exportInvoices() {
            if (filteredInvoiceData.length === 0) {
                showAlert('Tidak ada data untuk diexport!', 'warning');
                return;
            }

            let csvContent = "No,Email/Hard,Penerima,Corp,Tanggal Diterima,No Invoice,Nama Vendor,DPP,Status\n";
            
            filteredInvoiceData.forEach((invoice, index) => {
                const row = [
                    index + 1,
                    `"${invoice.Email_Hard || ''}"`,
                    `"${invoice.Penerima || ''}"`,
                    `"${invoice.Corp || ''}"`,
                    `"${invoice.Tanggal_Diterima || ''}"`,
                    `"${invoice.No_Invoice || ''}"`,
                    `"${invoice.Nama_Vendor || ''}"`,
                    `"${invoice.DPP_IDR || ''}"`,
                    `"${invoice.Status || ''}"`
                ].join(',');
                csvContent += row + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `invoices_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Data berhasil diexport!', 'success');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initLogin();
            loadVendorData();

            document.addEventListener('click', function(e) {
                if (e.target.closest('.nav-item')) {
                    const navItem = e.target.closest('.nav-item');
                    const targetId = navItem.dataset.target;
                    if (targetId) {
                        e.preventDefault();
                        showSection(targetId);
                    } else if (navItem.id === 'logout-btn') {
                        e.preventDefault();
                        logout();
                    }
                }
            });

            setupRupiahInput('pembayaran-dpp-idr');
            setupRupiahInput('pembayaran-ppn-idr');

            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggleBtn && sidebar) {
                sidebarToggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                });

                const savedSidebarState = localStorage.getItem('sidebarCollapsed');
                if (savedSidebarState === 'true') {
                    sidebar.classList.add('collapsed');
                }
            }

            setupModals();
            setupButtonListeners();
        });

    </script>

    <!-- Improved Login Screen -->
    <div id="auth-container" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-chart-line auth-logo-icon"></i>
                <span class="auth-logo-text">FinanceMonitor</span>
            </div>
            <h2>Login ke Akun Anda</h2>
            <form id="login-form" class="auth-form">
                <div class="auth-input-group">
                    <i class="fas fa-envelope auth-input-icon"></i>
                    <input type="email" id="email" class="auth-input" placeholder="Alamat Email" required>
                </div>
                <div class="auth-input-group">
                    <i class="fas fa-lock auth-input-icon"></i>
                    <input type="password" id="password" class="auth-input" placeholder="Password" required>
                </div>
                <div id="login-error" class="auth-error-message"></div>
                <button type="submit" id="login-btn" class="auth-submit-btn">Login</button>
            </form>
            <div class="auth-footer">
                <p>Sistem Monitoring Keuangan yang Aman</p>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until login) -->
    <div id="main-container" class="container" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <button id="sidebar-toggle-btn" class="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
                <div class="logo-text">FinanceMonitor</div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-target="dashboard-section">
                    <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="nav-text">Dashboard</div>
                </a>
                <a href="#" class="nav-item" data-target="invoice-list-section">
                    <div class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="nav-text">Invoice</div>
                </a>
                <a href="#" class="nav-item" data-target="faktur-pajak-section">
                    <div class="nav-icon"><i class="fas fa-receipt"></i></div>
                    <div class="nav-text">Faktur Pajak</div>
                </a>
                <a href="#" class="nav-item" data-target="pembayaran-section">
                    <div class="nav-icon"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="nav-text">Pembayaran</div>
                </a>
                <a href="#" class="nav-item" data-target="keterangan-section">
                    <div class="nav-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="nav-text">Keterangan</div>
                </a>
                <a href="#" class="nav-item" data-target="pengaturan-section">
                    <div class="nav-icon"><i class="fas fa-cog"></i></div>
                    <div class="nav-text">Pengaturan Akun</div>
                </a>
                <a href="#" class="nav-item" id="logout-btn">
                    <div class="nav-icon"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="nav-text">Logout</div>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <div class="header">
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h3>Ringkasan Status Invoice</h3>
                        <div class="dashboard-summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-total-invoice">0</div>
                                <div class="summary-label">Total Invoice</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-paid-invoice">0</div>
                                <div class="summary-label">Telah Dibayar</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-pending-invoice">0</div>
                                <div class="summary-label">Menunggu Pembayaran</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-submission-pending-invoice">0</div>
                                <div class="summary-label">Menunggu Pengajuan</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="dashboard-overdue-invoice">0</div>
                                <div class="summary-label">Jatuh Tempo</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Invoice List Section -->
            <section id="invoice-list-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Daftar Invoice</h1>
                    <div class="header-actions">
                        <button class="btn btn-outline export-btn">
                            <i class="fas fa-download btn-icon"></i> Export
                        </button>
                        <button class="btn btn-primary" id="add-invoice-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Invoice
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Filter Data</h2>
                    </div>
                    <div class="card-body">
                        <div class="filter-section">
                            <div class="filter-group">
                                <label class="filter-label">Tanggal Mulai</label>
                                <input type="date" class="filter-input" id="filter-start-date">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Tanggal Akhir</label>
                                <input type="date" class="filter-input" id="filter-end-date">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Status</label>
                                <select class="filter-input" id="filter-status">
                                    <option value="">Semua Status</option>
                                    <option value="Menunggu Pengajuan">Menunggu Pengajuan</option>
                                    <option value="Diajukan ke Finance">Diajukan ke Finance</option>
                                    <option value="Diterima Anggi">Diterima Anggi</option>
                                    <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                                    <option value="Dibayar">Dibayar</option>
                                    <option value="Jatuh Tempo">Jatuh Tempo</option>
                                    <option value="Dibatalkan">Dibatalkan</option>
                                    <option value="Belum Diproses">Belum Diproses</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Cari</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="filter-input" id="filter-search" placeholder="Cari invoice, vendor...">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary">
                            <i class="fas fa-filter btn-icon"></i> Terapkan Filter
                        </button>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Daftar Invoice</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="invoice-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Email/Hard</th>
                                        <th>Penerima</th>
                                        <th>Corp</th>
                                        <th>Tanggal Diterima</th>
                                        <th>No Invoice</th>
                                        <th>Nama Vendor</th>
                                        <th>DPP</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded here by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                            <div class="page-info">
                                Menampilkan 0-0 dari 0 data
                            </div>
                            <div class="page-controls">
                                <!-- Pagination buttons will be rendered here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Invoice Detail Section -->
            <section id="invoice-detail-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Detail Invoice: <span id="detail-invoice-no"></span></h1>
                    <div class="header-actions">
                        <button class="btn btn-outline" id="back-to-list-btn">
                            <i class="fas fa-arrow-left btn-icon"></i> Kembali ke Daftar
                        </button>
                        <button class="btn btn-outline" id="export-detail-btn">
                            <i class="fas fa-download btn-icon"></i> Export Detail
                        </button>
                        <button class="btn btn-primary" id="edit-full-invoice-btn">
                            <i class="fas fa-edit btn-icon"></i> Edit Invoice
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="detail-section">
                            <h3>Informasi Dasar Invoice</h3>
                            <div class="detail-item"><strong>Email/Hard:</strong> <span id="detail-email-hard"></span></div>
                            <div class="detail-item"><strong>Penerima:</strong> <span id="detail-penerima"></span></div>
                            <div class="detail-item"><strong>Corp:</strong> <span id="detail-corp"></span></div>
                            <div class="detail-item"><strong>Tanggal Diterima:</strong> <span id="detail-tgl-diterima"></span></div>
                            <div class="detail-item"><strong>Tanggal Invoice:</strong> <span id="detail-tgl-invoice"></span></div>
                            <div class="detail-item"><strong>Surat Jalan/BA:</strong> <span id="detail-surat-jalan"></span></div>
                            <div class="detail-item"><strong>Nama Vendor:</strong> <span id="detail-nama-vendor"></span></div>
                        </div>

                        <div class="detail-section">
                            <h3>Detail Faktur Pajak</h3>
                            <div class="detail-item"><strong>No Faktur Pajak:</strong> <span id="detail-no-faktur-pajak"></span></div>
                            <div class="detail-item"><strong>Tanggal Faktur Pajak:</strong> <span id="detail-tgl-faktur-pajak"></span></div>
                            <div class="detail-item">
                                <button class="btn btn-outline btn-sm" id="add-edit-faktur-pajak-btn">
                                    <i class="fas fa-plus btn-icon"></i> Tambah/Edit Faktur Pajak
                                </button>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Detail Pembayaran</h3>
                            <div class="detail-item"><strong>DPP (IDR):</strong> <span id="detail-dpp-idr"></span></div>
                            <div class="detail-item"><strong>PPn (IDR):</strong> <span id="detail-ppn-idr"></span></div>
                            <div class="detail-item"><strong>DPP (USD):</strong> <span id="detail-dpp-usd"></span></div>
                            <div class="detail-item"><strong>Keterangan Pembayaran:</strong> <span id="detail-keterangan-pembayaran"></span></div>
                            <div class="detail-item"><strong>Follow Up:</strong> <span id="detail-follow-up"></span></div>
                            <div class="detail-item"><strong>Hasil Follow Up:</strong> <span id="detail-hasil-follow-up"></span></div>
                            <div class="detail-item"><strong>TOP:</strong> <span id="detail-top"></span></div>
                            <div class="detail-item"><strong>Jatuh Tempo:</strong> <span id="detail-jatuh-tempo"></span></div>
                            <div class="detail-item">
                                <button class="btn btn-outline btn-sm" id="add-edit-pembayaran-btn">
                                    <i class="fas fa-plus btn-icon"></i> Tambah/Edit Pembayaran
                                </button>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Status & Proses Internal</h3>
                            <div class="detail-item"><strong>Tanggal Pengajuan ke Finance:</strong> <span id="detail-tgl-pengajuan-finance"></span></div>
                            <div class="detail-item"><strong>Tanggal Pengajuan (Reni):</strong> <span id="detail-tgl-pengajuan-reni"></span></div>
                            <div class="detail-item"><strong>Tanggal Diterima (Anggi):</strong> <span id="detail-tgl-diterima-anggi"></span></div>
                            <div class="detail-item"><strong>Lama Pengajuan:</strong> <span id="detail-lama-pengajuan"></span></div>
                            <div class="detail-item"><strong>Keterangan Proses:</strong> <span id="detail-keterangan-proses"></span></div>
                            <div class="detail-item"><strong>Tanggal Bayar:</strong> <span id="detail-tgl-bayar"></span></div>
                            <div class="detail-item"><strong>Status Akhir:</strong> <span id="detail-status-akhir"></span></div>
                            <div class="detail-item">
                                <button class="btn btn-outline btn-sm" id="add-edit-keterangan-btn">
                                    <i class="fas fa-plus btn-icon"></i> Tambah/Edit Keterangan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Faktur Pajak Section -->
            <section id="faktur-pajak-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Manajemen Faktur Pajak</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-faktur-pajak-standalone-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Faktur Pajak
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>Gunakan form di bawah untuk mencari No Invoice dan menambahkan/mengedit Faktur Pajak terkait.</p>
                        <div class="filter-group" style="max-width: 400px; margin-bottom: 1rem;">
                            <label class="filter-label">Cari No Invoice untuk Faktur Pajak</label>
                            <div class="autocomplete-container">
                                <input type="text" class="filter-input" id="search-invoice-faktur-pajak" placeholder="Masukkan No Invoice...">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="search-faktur-pajak-btn">Cari & Tambah/Edit</button>
                    </div>
                </div>
            </section>

            <!-- Pembayaran Section -->
            <section id="pembayaran-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Manajemen Pembayaran</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-pembayaran-standalone-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Pembayaran
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>Gunakan form di bawah untuk mencari No Invoice dan menambahkan/mengedit Pembayaran terkait.</p>
                        <div class="filter-group" style="max-width: 400px; margin-bottom: 1rem;">
                            <label class="filter-label">Cari No Invoice untuk Pembayaran</label>
                            <div class="autocomplete-container">
                                <input type="text" class="filter-input" id="search-invoice-pembayaran" placeholder="Masukkan No Invoice...">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="search-pembayaran-btn">Cari & Tambah/Edit</button>
                    </div>
                </div>
            </section>

            <!-- Keterangan Section -->
            <section id="keterangan-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Manajemen Keterangan & Status</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-keterangan-standalone-btn">
                            <i class="fas fa-plus btn-icon"></i> Tambah Keterangan
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>Gunakan form di bawah untuk mencari No Invoice dan menambahkan/mengedit Keterangan & Status terkait.</p>
                        <div class="filter-group" style="max-width: 400px; margin-bottom: 1rem;">
                            <label class="filter-label">Cari No Invoice untuk Keterangan</label>
                            <div class="autocomplete-container">
                                <input type="text" class="filter-input" id="search-invoice-keterangan" placeholder="Masukkan No Invoice...">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="search-keterangan-btn">Cari & Tambah/Edit</button>
                    </div>
                </div>
            </section>

            <!-- Pengaturan Section -->
            <section id="pengaturan-section" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">Pengaturan Akun</h1>
                </div>
                <div class="settings-layout">
                    <div class="card settings-card">
                        <div class="card-body">
                            <form id="settings-form">
                                <div class="form-group">
                                    <label for="settings-email">Email</label>
                                    <input type="email" id="settings-email" class="filter-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-password">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                                    <input type="password" id="settings-password" class="filter-input" placeholder="Minimal 6 karakter">
                                </div>
                                <div class="form-group">
                                    <label for="settings-confirm-password">Konfirmasi Password Baru</label>
                                    <input type="password" id="settings-confirm-password" class="filter-input">
                                </div>
                                <div class="form-group">
                                    <a href="#" id="forgot-password-link" style="color: var(--primary); text-decoration: underline; font-size: 0.9rem;">Lupa Password?</a>
                                </div>
                                <p class="error-message" id="forgot-password-error-message" style="display: none;"></p>
                                <p class="status-paid" id="forgot-password-success-message" style="display: none; padding: 0.5rem; border-radius: 0.5rem;"></p>
                                <p class="error-message" id="settings-error-message" style="display: none;"></p>
                                <p class="status-paid" id="settings-success-message" style="display: none; padding: 0.5rem; border-radius: 0.5rem;"></p>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->

    <!-- Modal Tambah/Edit Invoice -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Invoice</h2>
            <form id="invoice-form">
                <div class="form-group">
                    <label for="invoice-email-hard">Email/Hard</label>
                    <select id="invoice-email-hard" class="filter-input" required>
                        <option value="">Pilih</option>
                        <option value="Email">Email</option>
                        <option value="Hard">Hardcopy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="invoice-penerima">Penerima</label>
                    <input type="text" id="invoice-penerima" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-corp">Corp</label>
                    <input type="text" id="invoice-corp" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-tgl-diterima">Tanggal Diterima</label>
                    <input type="date" id="invoice-tgl-diterima" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-tgl-invoice">Tanggal Invoice</label>
                    <input type="date" id="invoice-tgl-invoice" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="invoice-surat-jalan">Surat Jalan/BA</label>
                    <input type="text" id="invoice-surat-jalan" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="invoice-nama-vendor">Nama Vendor</label>
                    <div class="autocomplete-container">
                        <input type="text" id="invoice-nama-vendor" class="filter-input" required placeholder="Ketik untuk mencari vendor...">
                    </div>
                </div>
                <div class="form-group">
                    <label for="invoice-no-invoice">No Invoice</label>
                    <input type="text" id="invoice-no-invoice" class="filter-input" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Faktur Pajak -->
    <div id="faktur-pajak-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Faktur Pajak</h2>
            <form id="faktur-pajak-form">
                <div class="form-group">
                    <label for="fp-no-invoice">No Invoice</label>
                    <input type="text" id="fp-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="fp-tgl-faktur-pajak">Tanggal Faktur Pajak</label>
                    <input type="date" id="fp-tgl-faktur-pajak" class="filter-input" required>
                </div>
                <div class="form-group">
                    <label for="fp-no-faktur-pajak">No Faktur Pajak</label>
                    <input type="text" id="fp-no-faktur-pajak" class="filter-input" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Faktur Pajak</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Pembayaran -->
    <div id="pembayaran-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Pembayaran</h2>
            <form id="pembayaran-form">
                <div class="form-group">
                    <label for="pembayaran-no-invoice">No Invoice</label>
                    <input type="text" id="pembayaran-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="pembayaran-dpp-idr">DPP (IDR)</label>
                    <input type="text" id="pembayaran-dpp-idr" class="filter-input rupiah-input" placeholder="Rp 0" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pembayaran-include-ppn">
                    <label for="pembayaran-include-ppn">Harga sudah termasuk PPN 11%</label>
                </div>
                <div class="form-group">
                    <label for="pembayaran-ppn-idr">PPn (IDR)</label>
                    <input type="text" id="pembayaran-ppn-idr" class="filter-input rupiah-input" placeholder="Rp 0" readonly>
                </div>
                <div class="form-group">
                    <label for="pembayaran-dpp-usd">DPP (USD)</label>
                    <input type="text" id="pembayaran-dpp-usd" class="filter-input" placeholder="$ 0.00">
                </div>
                <div class="form-group">
                    <label for="pembayaran-keterangan">Keterangan</label>
                    <textarea id="pembayaran-keterangan" class="filter-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="pembayaran-follow-up">Follow Up</label>
                    <select id="pembayaran-follow-up" class="filter-input">
                        <option value="Tidak">Tidak</option>
                        <option value="Ya">Ya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pembayaran-hasil-follow-up">Hasil Follow Up</label>
                    <textarea id="pembayaran-hasil-follow-up" class="filter-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="pembayaran-top">TOP (Term of Payment)</label>
                    <input type="number" id="pembayaran-top" class="filter-input" placeholder="Contoh: 30">
                </div>
                <div class="form-group">
                    <label for="pembayaran-jatuh-tempo">Jatuh Tempo</label>
                    <input type="date" id="pembayaran-jatuh-tempo" class="filter-input">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Pembayaran</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Keterangan -->
    <div id="keterangan-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Form Keterangan & Status</h2>
            <form id="keterangan-form">
                <div class="form-group">
                    <label for="keterangan-no-invoice">No Invoice</label>
                    <input type="text" id="keterangan-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-pengajuan-finance">Tanggal Pengajuan ke Finance</label>
                    <input type="date" id="keterangan-tgl-pengajuan-finance" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-pengajuan-reni">Tanggal Pengajuan (Reni)</label>
                    <input type="date" id="keterangan-tgl-pengajuan-reni" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-diterima-anggi">Tanggal Diterima (Anggi)</label>
                    <input type="date" id="keterangan-tgl-diterima-anggi" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-lama-pengajuan">Lama Pengajuan (Hari)</label>
                    <input type="text" id="keterangan-lama-pengajuan" class="filter-input" readonly placeholder="Otomatis dihitung">
                </div>
                <div class="form-group">
                    <label for="keterangan-keterangan-proses">Keterangan Proses</label>
                    <textarea id="keterangan-keterangan-proses" class="filter-input"></textarea>
                </div>
                <div class="form-group">
                    <label for="keterangan-tgl-bayar">Tanggal Bayar</label>
                    <input type="date" id="keterangan-tgl-bayar" class="filter-input">
                </div>
                <div class="form-group">
                    <label for="keterangan-status-akhir">Status Akhir</label>
                    <select id="keterangan-status-akhir" class="filter-input">
                        <option value="">Pilih Status</option>
                        <option value="Menunggu Pengajuan">Menunggu Pengajuan</option>
                        <option value="Diajukan ke Finance">Diajukan ke Finance</option>
                        <option value="Diterima Anggi">Diterima Anggi</option>
                        <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                        <option value="Dibayar">Dibayar</option>
                        <option value="Jatuh Tempo">Jatuh Tempo</option>
                        <option value="Dibatalkan">Dibatalkan</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Keterangan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Manual Status Update -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2 class="card-title" style="margin-bottom: 1.5rem;">Ubah Status Invoice Manual</h2>
            <form id="status-form">
                <div class="form-group">
                    <label for="status-no-invoice">No Invoice</label>
                    <input type="text" id="status-no-invoice" class="filter-input" readonly required>
                </div>
                <div class="form-group">
                    <label for="status-manual-select">Pilih Status Manual</label>
                    <select id="status-manual-select" class="filter-input" required>
                        <option value="">Pilih Status</option>
                        <option value="Menunggu Pengajuan">Menunggu Pengajuan</option>
                        <option value="Diajukan ke Finance">Diajukan ke Finance</option>
                        <option value="Diterima Anggi">Diterima Anggi</option>
                        <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                        <option value="Dibayar">Dibayar</option>
                        <option value="Jatuh Tempo">Jatuh Tempo</option>
                        <option value="Dibatalkan">Dibatalkan</option>
                        <option value="Belum Diproses">Belum Diproses</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Simpan Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Box -->
    <div id="custom-alert-box" class="custom-alert"></div>
</body>
</html>
